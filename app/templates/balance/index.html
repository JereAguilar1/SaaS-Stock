{% extends "base.html" %}

{% block title %}Balance Financiero - Sistema Ferretería{% endblock %}

{% block page_title %}Balance Financiero{% endblock %}

{% block topbar_actions %}
<a href="{{ url_for('balance.list_ledger') }}" class="btn-custom btn-secondary-custom">
    <i class="bi bi-journal-text"></i> Ver Libro Mayor
</a>
{% endblock %}

{% block content %}
<!-- Tabs -->
<div style="margin-bottom: var(--spacing-6); border-bottom: 1px solid var(--color-border-light);">
    <div style="display: flex; gap: var(--spacing-4);">
        <a href="{{ url_for('balance.index', view='daily') }}"
            style="padding: var(--spacing-2) var(--spacing-4); text-decoration: none; color: {% if view == 'daily' %}var(--color-primary){% else %}var(--color-text-secondary){% endif %}; border-bottom: 2px solid {% if view == 'daily' %}var(--color-primary){% else %}transparent{% endif %}; font-weight: var(--font-weight-medium); transition: all var(--transition-fast);">
            <i class="bi bi-calendar-day"></i> Diario
        </a>
        <a href="{{ url_for('balance.index', view='monthly') }}"
            style="padding: var(--spacing-2) var(--spacing-4); text-decoration: none; color: {% if view == 'monthly' %}var(--color-primary){% else %}var(--color-text-secondary){% endif %}; border-bottom: 2px solid {% if view == 'monthly' %}var(--color-primary){% else %}transparent{% endif %}; font-weight: var(--font-weight-medium); transition: all var(--transition-fast);">
            <i class="bi bi-calendar-month"></i> Mensual
        </a>
        <a href="{{ url_for('balance.index', view='yearly') }}"
            style="padding: var(--spacing-2) var(--spacing-4); text-decoration: none; color: {% if view == 'yearly' %}var(--color-primary){% else %}var(--color-text-secondary){% endif %}; border-bottom: 2px solid {% if view == 'yearly' %}var(--color-primary){% else %}transparent{% endif %}; font-weight: var(--font-weight-medium); transition: all var(--transition-fast);">
            <i class="bi bi-calendar"></i> Anual
        </a>
    </div>
</div>

<!-- Mode Toggle -->
<div class="card-custom" style="margin-bottom: var(--spacing-4);">
    <div class="card-body-custom" style="padding: var(--spacing-3);">
        <div
            style="display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; gap: var(--spacing-3);">
            <div>
                <h3
                    style="margin: 0; font-size: var(--font-size-base); font-weight: var(--font-weight-semibold); color: var(--color-text);">
                    <i class="bi bi-eye"></i> Modo de Visualización
                </h3>
                <p
                    style="margin: var(--spacing-1) 0 0 0; font-size: var(--font-size-sm); color: var(--color-text-muted);">
                    {% if view == 'daily' %}
                    Individual: Ver un día específico | Agrupada: Ver todos los días del mes
                    {% elif view == 'monthly' %}
                    Individual: Ver un mes específico | Agrupada: Ver todos los meses del año
                    {% else %}
                    Individual: Ver un año específico | Agrupada: Ver todos los años disponibles
                    {% endif %}
                </p>
            </div>
            <div class="btn-group" role="group"
                style="display: flex; gap: 0; border-radius: var(--border-radius); overflow: hidden; box-shadow: var(--shadow-sm);">
                <a href="{{ url_for('balance.index', view=view, mode='individual', year=selected_year, month=selected_month, day=selected_day, method=selected_method) }}"
                    class="btn-custom {% if mode == 'individual' %}btn-primary-custom{% else %}btn-secondary-custom{% endif %}"
                    style="border-radius: 0; {% if mode == 'individual' %}font-weight: var(--font-weight-semibold);{% endif %}">
                    <i class="bi bi-file-earmark-text"></i> Individual
                </a>
                <a href="{{ url_for('balance.index', view=view, mode='grouped', year=selected_year, month=selected_month, method=selected_method) }}"
                    class="btn-custom {% if mode == 'grouped' %}btn-primary-custom{% else %}btn-secondary-custom{% endif %}"
                    style="border-radius: 0; {% if mode == 'grouped' %}font-weight: var(--font-weight-semibold);{% endif %}">
                    <i class="bi bi-list-ul"></i> Agrupada
                </a>
            </div>
        </div>
    </div>
</div>

<!-- Filters Card -->
<div class="card-custom" style="margin-bottom: var(--spacing-6);">
    <div class="card-body-custom">
        {% if view == 'daily' %}
        <form method="GET" action="{{ url_for('balance.index') }}"
            class="form-row {% if mode == 'individual' %}form-row-4{% else %}form-row-3{% endif %}">
            <input type="hidden" name="view" value="daily">
            <input type="hidden" name="mode" value="{{ mode }}">

            {% if mode == 'individual' %}
            <!-- MODO INDIVIDUAL: Selector de día específico -->
            <div class="form-group">
                <label for="day" class="form-label-custom">
                    <i class="bi bi-calendar-day"></i> Día Específico
                </label>
                <input type="date" class="form-input-custom" id="day" name="day" value="{{ selected_day }}" required>
            </div>
            {% else %}
            <!-- MODO AGRUPADA: Selectores de año y mes -->
            <div class="form-group">
                <label for="year" class="form-label-custom">
                    <i class="bi bi-calendar"></i> Año
                </label>
                <select class="form-select-custom" id="year" name="year" required>
                    {% if available_years %}
                    {% for year in available_years %}
                    <option value="{{ year }}" {% if selected_year==year %}selected{% endif %}>
                        {{ year }}
                    </option>
                    {% endfor %}
                    {% else %}
                    <option value="{{ selected_year or '' }}">{{ selected_year or 'Sin datos' }}</option>
                    {% endif %}
                </select>
            </div>

            <div class="form-group">
                <label for="month" class="form-label-custom">
                    <i class="bi bi-calendar-month"></i> Mes
                </label>
                <select class="form-select-custom" id="month" name="month" required>
                    <option value="1" {% if selected_month==1 %}selected{% endif %}>Enero</option>
                    <option value="2" {% if selected_month==2 %}selected{% endif %}>Febrero</option>
                    <option value="3" {% if selected_month==3 %}selected{% endif %}>Marzo</option>
                    <option value="4" {% if selected_month==4 %}selected{% endif %}>Abril</option>
                    <option value="5" {% if selected_month==5 %}selected{% endif %}>Mayo</option>
                    <option value="6" {% if selected_month==6 %}selected{% endif %}>Junio</option>
                    <option value="7" {% if selected_month==7 %}selected{% endif %}>Julio</option>
                    <option value="8" {% if selected_month==8 %}selected{% endif %}>Agosto</option>
                    <option value="9" {% if selected_month==9 %}selected{% endif %}>Septiembre</option>
                    <option value="10" {% if selected_month==10 %}selected{% endif %}>Octubre</option>
                    <option value="11" {% if selected_month==11 %}selected{% endif %}>Noviembre</option>
                    <option value="12" {% if selected_month==12 %}selected{% endif %}>Diciembre</option>
                </select>
            </div>
            {% endif %}

            <div class="form-group">
                <label for="method_daily" class="form-label-custom">
                    <i class="bi bi-cash-coin"></i> Método
                </label>
                <div style="display: flex; gap: var(--spacing-2);">
                    <select class="form-select-custom" id="method_daily" name="method">
                        <option value="all" {% if selected_method=='all' %}selected{% endif %}>Todos</option>
                        <option value="cash" {% if selected_method=='cash' %}selected{% endif %}>Efectivo</option>
                        <option value="transfer" {% if selected_method=='transfer' %}selected{% endif %}>Transferencia
                        </option>
                    </select>

                    <button type="submit" class="btn-custom btn-primary-custom">
                        <i class="bi bi-funnel"></i>
                    </button>
                    <a href="{{ url_for('balance.index', view='daily', mode=mode) }}"
                        class="btn-custom btn-secondary-custom">
                        <i class="bi bi-x-circle"></i>
                    </a>
                </div>
            </div>

            {% if mode == 'individual' and selected_day %}
            <div style="grid-column: 1 / -1;">
                <div class="alert-custom alert-info" style="margin-bottom: 0;">
                    <i class="alert-custom-icon bi bi-info-circle-fill"></i>
                    <div class="alert-custom-content">
                        Mostrando balance para el día <strong>{{ selected_day }}</strong>
                        {% if selected_method != 'all' %}
                        - Método: <strong>{% if selected_method == 'cash' %}Efectivo{% else %}Transferencia{% endif
                            %}</strong>
                        {% endif %}
                    </div>
                </div>
            </div>
            {% elif mode == 'grouped' and selected_year and selected_month %}
            <div style="grid-column: 1 / -1;">
                <div class="alert-custom alert-info" style="margin-bottom: 0;">
                    <i class="alert-custom-icon bi bi-info-circle-fill"></i>
                    <div class="alert-custom-content">
                        Mostrando balance para el día <strong>{{ selected_day }}</strong>
                        {% if selected_method != 'all' %}
                        - Método: <strong>{% if selected_method == 'cash' %}Efectivo{% else %}Transferencia{% endif
                            %}</strong>
                        {% endif %}
                    </div>
                </div>
            </div>
            {% elif selected_year and selected_month %}
            <div style="grid-column: 1 / -1;">
                <div class="alert-custom alert-info" style="margin-bottom: 0;">
                    <i class="alert-custom-icon bi bi-info-circle-fill"></i>
                    <div class="alert-custom-content">
                        Mostrando balance diario para <strong>{{ ['', 'Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo',
                            'Junio', 'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre',
                            'Diciembre'][selected_month] }} {{ selected_year }}</strong>
                        {% if selected_method != 'all' %}
                        - Método: <strong>{% if selected_method == 'cash' %}Efectivo{% else %}Transferencia{% endif
                            %}</strong>
                        {% endif %}
                    </div>
                </div>
            </div>
            {% endif %}
        </form>

        {% elif view == 'monthly' %}
        <form method="GET" action="{{ url_for('balance.index') }}"
            class="form-row {% if mode == 'individual' %}form-row-3{% else %}form-row-2{% endif %}">
            <input type="hidden" name="view" value="monthly">
            <input type="hidden" name="mode" value="{{ mode }}">

            <div class="form-group">
                <label for="year" class="form-label-custom">
                    <i class="bi bi-calendar"></i> Año
                </label>
                <select class="form-select-custom" id="year" name="year" required>
                    {% if available_years %}
                    {% for year in available_years %}
                    <option value="{{ year }}}" {% if selected_year==year %}selected{% endif %}>
                        {{ year }}
                    </option>
                    {% endfor %}
                    {% else %}
                    <option value="{{ selected_year or '' }}">{{ selected_year or 'Sin datos' }}</option>
                    {% endif %}
                </select>
            </div>

            {% if mode == 'individual' %}
            <!-- MODO INDIVIDUAL: Selector de mes específico -->
            <div class="form-group">
                <label for="month" class="form-label-custom">
                    <i class="bi bi-calendar-month"></i> Mes
                </label>
                <select class="form-select-custom" id="month" name="month" required>
                    <option value="1" {% if selected_month==1 %}selected{% endif %}>Enero</option>
                    <option value="2" {% if selected_month==2 %}selected{% endif %}>Febrero</option>
                    <option value="3" {% if selected_month==3 %}selected{% endif %}>Marzo</option>
                    <option value="4" {% if selected_month==4 %}selected{% endif %}>Abril</option>
                    <option value="5" {% if selected_month==5 %}selected{% endif %}>Mayo</option>
                    <option value="6" {% if selected_month==6 %}selected{% endif %}>Junio</option>
                    <option value="7" {% if selected_month==7 %}selected{% endif %}>Julio</option>
                    <option value="8" {% if selected_month==8 %}selected{% endif %}>Agosto</option>
                    <option value="9" {% if selected_month==9 %}selected{% endif %}>Septiembre</option>
                    <option value="10" {% if selected_month==10 %}selected{% endif %}>Octubre</option>
                    <option value="11" {% if selected_month==11 %}selected{% endif %}>Noviembre</option>
                    <option value="12" {% if selected_month==12 %}selected{% endif %}>Diciembre</option>
                </select>
            </div>
            {% endif %}

            <div class="form-group">
                <label for="method_monthly" class="form-label-custom">
                    <i class="bi bi-cash-coin"></i> Método
                </label>
                <div style="display: flex; gap: var(--spacing-2);">
                    <select class="form-select-custom" id="method_monthly" name="method">
                        <option value="all" {% if selected_method=='all' %}selected{% endif %}>Todos</option>
                        <option value="cash" {% if selected_method=='cash' %}selected{% endif %}>Efectivo</option>
                        <option value="transfer" {% if selected_method=='transfer' %}selected{% endif %}>Transferencia
                        </option>
                    </select>

                    <button type="submit" class="btn-custom btn-primary-custom">
                        <i class="bi bi-funnel"></i>
                    </button>
                    <a href="{{ url_for('balance.index', view='monthly', mode=mode) }}"
                        class="btn-custom btn-secondary-custom">
                        <i class="bi bi-x-circle"></i>
                    </a>
                </div>
            </div>

            {% if mode == 'individual' and selected_year and selected_month %}
            <div style="grid-column: 1 / -1;">
                <div class="alert-custom alert-info" style="margin-bottom: 0;">
                    <i class="alert-custom-icon bi bi-info-circle-fill"></i>
                    <div class="alert-custom-content">
                        Mostrando balance del mes <strong>{{ ['', 'Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo',
                            'Junio', 'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre',
                            'Diciembre'][selected_month] }} {{ selected_year }}</strong>
                        {% if selected_method != 'all' %}
                        - Método: <strong>{% if selected_method == 'cash' %}Efectivo{% else %}Transferencia{% endif
                            %}</strong>
                        {% endif %}
                    </div>
                </div>
            </div>
            {% elif mode == 'grouped' and selected_year %}
            <div style="grid-column: 1 / -1;">
                <div class="alert-custom alert-info" style="margin-bottom: 0;">
                    <i class="alert-custom-icon bi bi-info-circle-fill"></i>
                    <div class="alert-custom-content">
                        Mostrando balance mensual para el año <strong>{{ selected_year }}</strong>
                        {% if selected_method != 'all' %}
                        - Método: <strong>{% if selected_method == 'cash' %}Efectivo{% else %}Transferencia{% endif
                            %}</strong>
                        {% endif %}
                    </div>
                </div>
            </div>
            {% endif %}
        </form>

        {% else %}
        <!-- Yearly view -->
        <form method="GET" action="{{ url_for('balance.index') }}"
            class="form-row {% if mode == 'individual' %}form-row-2{% else %}form-row-1{% endif %}">
            <input type="hidden" name="view" value="yearly">
            <input type="hidden" name="mode" value="{{ mode }}">

            {% if mode == 'individual' %}
            <!-- MODO INDIVIDUAL: Selector de año específico -->
            <div class="form-group">
                <label for="year" class="form-label-custom">
                    <i class="bi bi-calendar"></i> Año
                </label>
                <select class="form-select-custom" id="year" name="year" required>
                    {% if available_years %}
                    {% for year in available_years %}
                    <option value="{{ year }}" {% if selected_year==year %}selected{% endif %}>
                        {{ year }}
                    </option>
                    {% endfor %}
                    {% else %}
                    <option value="{{ selected_year or '' }}">{{ selected_year or 'Sin datos' }}</option>
                    {% endif %}
                </select>
            </div>
            {% else %}
            <!-- MODO AGRUPADA: Sin selector (muestra todos los años) -->
            <div class="form-group" style="grid-column: 1 / -1;">
                <div class="alert-custom alert-info" style="margin-bottom: 0;">
                    <i class="alert-custom-icon bi bi-info-circle-fill"></i>
                    <div class="alert-custom-content">
                        Mostrando todos los años disponibles en el sistema
                    </div>
                </div>
            </div>
            {% endif %}

            <div class="form-group">
                <label for="method_yearly" class="form-label-custom">
                    <i class="bi bi-cash-coin"></i> Método
                </label>
                <div style="display: flex; gap: var(--spacing-2);">
                    <select class="form-select-custom" id="method_yearly" name="method">
                        <option value="all" {% if selected_method=='all' %}selected{% endif %}>Todos</option>
                        <option value="cash" {% if selected_method=='cash' %}selected{% endif %}>Efectivo</option>
                        <option value="transfer" {% if selected_method=='transfer' %}selected{% endif %}>Transferencia
                        </option>
                    </select>

                    <button type="submit" class="btn-custom btn-primary-custom">
                        <i class="bi bi-funnel"></i>
                    </button>
                    <a href="{{ url_for('balance.index', view='yearly', mode=mode) }}"
                        class="btn-custom btn-secondary-custom">
                        <i class="bi bi-x-circle"></i>
                    </a>
                </div>
            </div>

            {% if mode == 'individual' and selected_year %}
            <div style="grid-column: 1 / -1;">
                <div class="alert-custom alert-info" style="margin-bottom: 0;">
                    <i class="alert-custom-icon bi bi-info-circle-fill"></i>
                    <div class="alert-custom-content">
                        Mostrando balance del año <strong>{{ selected_year }}</strong>
                        {% if selected_method != 'all' %}
                        - Método: <strong>{% if selected_method == 'cash' %}Efectivo{% else %}Transferencia{% endif
                            %}</strong>
                        {% endif %}
                    </div>
                </div>
            </div>
            {% endif %}
        </form>
        {% endif %}
    </div>
</div>

<!-- Totals Cards -->
<div
    style="display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: var(--spacing-6); margin-bottom: var(--spacing-6);">
    <div class="stat-card" style="border-left: 4px solid var(--color-success);">
        <div class="stat-label">Ingresos Totales</div>
        <div class="stat-value" style="color: var(--color-success);">${{ "%.2f"|format(totals.total_income) }}</div>
        <div class="stat-change positive">
            <i class="bi bi-arrow-down-circle"></i> Entradas
        </div>
    </div>

    <div class="stat-card" style="border-left: 4px solid var(--color-danger);">
        <div class="stat-label">Egresos Totales</div>
        <div class="stat-value" style="color: var(--color-danger);">${{ "%.2f"|format(totals.total_expense) }}</div>
        <div class="stat-change negative">
            <i class="bi bi-arrow-up-circle"></i> Salidas
        </div>
    </div>

    <div class="stat-card"
        style="border-left: 4px solid {% if totals.total_net >= 0 %}var(--color-primary){% else %}var(--color-warning){% endif %};">
        <div class="stat-label">Neto (Ganancia/Pérdida)</div>
        <div class="stat-value"
            style="color: {% if totals.total_net >= 0 %}var(--color-primary){% else %}var(--color-warning){% endif %};">
            ${{ "%.2f"|format(totals.total_net) }}
        </div>
        <div class="stat-change">
            <i class="bi bi-calculator"></i> Resultado
        </div>
    </div>
</div>

<!-- Balance Table -->
<div class="card-custom">
    <div class="card-header-custom"
        style="background-color: var(--color-bg-surface); border-bottom: 2px solid var(--color-primary);">
        <h2 class="card-title" style="color: var(--color-primary);">
            Balance
            {% if view == 'daily' %}Diario
            {% elif view == 'monthly' %}Mensual
            {% else %}Anual
            {% endif %}
        </h2>
    </div>
    {% if series %}
    <div class="table-container">
        <table class="table-custom">
            <thead>
                <tr>
                    <th>Período</th>
                    <th style="text-align: right;">Ingresos</th>
                    <th style="text-align: right;">Egresos</th>
                    <th style="text-align: right;">Neto</th>
                </tr>
            </thead>
            <tbody>
                {% for item in series %}
                <tr>
                    <td><strong>
                            {% if view == 'daily' %}
                            {{ item.period|date_ar }}
                            {% elif view == 'monthly' %}
                            {{ item.period|month_ar }}
                            {% else %}
                            {{ item.period|year_ar }}
                            {% endif %}
                        </strong></td>
                    <td style="text-align: right; color: var(--color-success);">
                        {% if item.income > 0 %}
                        ${{ "%.2f"|format(item.income) }}
                        {% else %}
                        <span style="color: var(--color-text-muted);">$0.00</span>
                        {% endif %}
                    </td>
                    <td style="text-align: right; color: var(--color-danger);">
                        {% if item.expense > 0 %}
                        ${{ "%.2f"|format(item.expense) }}
                        {% else %}
                        <span style="color: var(--color-text-muted);">$0.00</span>
                        {% endif %}
                    </td>
                    <td
                        style="text-align: right; font-weight: var(--font-weight-semibold); color: {% if item.net >= 0 %}var(--color-primary){% else %}var(--color-warning){% endif %};">
                        ${{ "%.2f"|format(item.net) }}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
            <tfoot style="background-color: var(--color-bg-muted); font-weight: var(--font-weight-bold);">
                <tr>
                    <td style="padding: var(--spacing-4);">TOTALES</td>
                    <td style="text-align: right; padding: var(--spacing-4); color: var(--color-success);">
                        ${{ "%.2f"|format(totals.total_income) }}
                    </td>
                    <td style="text-align: right; padding: var(--spacing-4); color: var(--color-danger);">
                        ${{ "%.2f"|format(totals.total_expense) }}
                    </td>
                    <td
                        style="text-align: right; padding: var(--spacing-4); color: {% if totals.total_net >= 0 %}var(--color-primary){% else %}var(--color-warning){% endif %};">
                        ${{ "%.2f"|format(totals.total_net) }}
                    </td>
                </tr>
            </tfoot>
        </table>
    </div>

    <div class="card-footer-custom">
        <p style="margin: 0; font-size: var(--font-size-sm); color: var(--color-text-muted);">
            <i class="bi bi-info-circle"></i>
            Mostrando {{ series|length }} período(s) desde <strong>{{ start|date_ar }}</strong> hasta <strong>{{
                end|date_ar }}</strong>
        </p>
    </div>
    {% else %}
    <div class="card-body-custom">
        <div class="empty-state">
            <i class="empty-state-icon bi bi-graph-up"></i>
            <div class="empty-state-title">Datos no disponibles</div>
            <p class="empty-state-description">
                No hay datos financieros para el rango de fechas seleccionado.
                <br>
                <small>Los ingresos provienen de ventas confirmadas y los egresos de boletas pagadas.</small>
            </p>
        </div>
    </div>
    {% endif %}
</div>

<!-- Help Card -->
<div class="card-custom" style="margin-top: var(--spacing-6);">
    <div class="card-header-custom" style="background-color: var(--color-bg-muted);">
        <h6 class="card-title" style="font-size: var(--font-size-sm); margin: 0;">
            <i class="bi bi-question-circle"></i> Información
        </h6>
    </div>
    <div class="card-body-custom">
        <ul
            style="font-size: var(--font-size-sm); color: var(--color-text-secondary); margin: 0; padding-left: var(--spacing-5);">
            <li><strong>Ingresos:</strong> Provienen de ventas confirmadas (type=INCOME en finance_ledger)</li>
            <li><strong>Egresos:</strong> Provienen de pagos de boletas a proveedores (type=EXPENSE en finance_ledger)
            </li>
            <li><strong>Neto:</strong> Diferencia entre ingresos y egresos (Ingresos - Egresos)</li>
            <li><strong>Vista Diaria:</strong> Muestra balance agrupado por día</li>
            <li><strong>Vista Mensual:</strong> Muestra balance agrupado por mes</li>
            <li><strong>Vista Anual:</strong> Muestra balance agrupado por año</li>
        </ul>
    </div>
</div>
{% endblock %}