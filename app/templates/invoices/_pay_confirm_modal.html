<div class="modal fade" id="confirmPayInvoiceModal" tabindex="-1" aria-labelledby="confirmPayInvoiceModalLabel"
    aria-hidden="true" data-bs-backdrop="static">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content"
            style="border-radius: var(--radius-xl); border: none; box-shadow: var(--shadow-2xl);">
            <div class="modal-header"
                style="background-color: var(--color-success); color: white; border-bottom: 1px solid rgba(0,0,0,0.05);">
                <h5 class="modal-title" id="confirmPayInvoiceModalLabel"
                    style="font-weight: var(--font-weight-bold); display: flex; align-items: center; gap: var(--spacing-2);">
                    <i class="bi bi-cash-coin"></i> Registrar Pago - Boleta #{{ invoice.id }}
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"
                    aria-label="Close"></button>
            </div>
            <div class="modal-body" style="background-color: var(--color-bg-body); padding: var(--spacing-6);">

                <!-- Balance Info -->
                <div class="alert-custom alert-info"
                    style="margin-bottom: var(--spacing-6); display: flex; justify-content: space-between; align-items: center;">
                    <div>
                        <div style="font-size: var(--font-size-xs); text-transform: uppercase;">Total Boleta</div>
                        <div style="font-weight: bold;">${{ invoice.total_amount|money_ar_2 }}</div>
                    </div>
                    <div style="text-align: right;">
                        <div
                            style="font-size: var(--font-size-xs); text-transform: uppercase; color: var(--color-danger);">
                            Saldo Pendiente</div>
                        <div style="font-weight: bold; font-size: var(--font-size-lg); color: var(--color-danger);">${{
                            (invoice.total_amount - invoice.paid_amount)|money_ar_2 }}</div>
                    </div>
                </div>

                <!-- Payment Form -->
                <form hx-post="{{ url_for('invoices.register_payment_route', invoice_id=invoice.id) }}"
                    hx-target="#modal-errors" hx-swap="innerHTML" id="confirmPayForm">

                    <div id="modal-errors" style="margin-bottom: var(--spacing-4);"></div>

                    <div
                        style="display: grid; grid-template-columns: 1fr 1fr; gap: var(--spacing-4); margin-bottom: var(--spacing-4);">
                        <div class="form-group">
                            <label for="amount_modal" class="form-label-custom">
                                Monto a Pagar <span style="color: var(--color-danger);">*</span>
                            </label>
                            <div class="input-group">
                                <span class="input-group-text">$</span>
                                <input type="text" class="form-control form-input-custom" id="amount_modal"
                                    name="amount_display"
                                    value="{{ '{:,.2f}'.format(pending_amount).replace(',', 'X').replace('.', ',').replace('X', '.') }}"
                                    inputmode="decimal" required placeholder="1.000,00">
                                <input type="hidden" id="amount_hidden" name="amount" value="{{ pending_amount }}">
                            </div>
                        </div>

                        <div class="form-group">
                            <label for="payment_method_modal" class="form-label-custom">
                                M√©todo <span style="color: var(--color-danger);">*</span>
                            </label>
                            <select class="form-select-custom" id="payment_method_modal" name="payment_method" required>
                                <option value="CASH" selected>üíµ Efectivo</option>
                                <option value="TRANSFER">üè¶ Transferencia</option>
                            </select>
                        </div>
                    </div>

                    <div class="form-group" style="margin-bottom: var(--spacing-4);">
                        <label for="paid_at_modal" class="form-label-custom">
                            Fecha de Pago <span style="color: var(--color-danger);">*</span>
                        </label>
                        <input type="date" class="form-input-custom" id="paid_at_modal" name="paid_at"
                            value="{{ today }}" required>
                    </div>

                    <div class="form-group" style="margin-bottom: var(--spacing-4);">
                        <label for="notes_modal" class="form-label-custom">Notas (Opcional)</label>
                        <textarea class="form-input-custom" id="notes_modal" name="notes" rows="2"
                            placeholder="Referencia, n¬∫ operaci√≥n, etc..."></textarea>
                    </div>

                    <!-- Warning -->
                    <div
                        style="font-size: var(--font-size-xs); color: var(--color-text-secondary); margin-bottom: var(--spacing-4);">
                        <i class="bi bi-info-circle"></i> Se registrar√° un egreso en el libro mayor financiero.
                    </div>

                    <!-- Form Actions -->
                    <div
                        style="display: flex; gap: var(--spacing-3); justify-content: flex-end; padding-top: var(--spacing-4); border-top: 1px solid var(--color-border-light);">
                        <button type="button" class="btn-custom btn-secondary-custom" data-bs-dismiss="modal">
                            Cancelar
                        </button>
                        <button type="submit" class="btn-custom btn-primary-custom"
                            style="background-color: var(--color-success); border-color: var(--color-success); min-width: 120px;"
                            id="confirmPayBtn">
                            Registrar Pago
                        </button>
                    </div>

                </form>
            </div>
            <div class="modal-footer" style="display: none;">
                <!-- Footer moved inside form -->
            </div>
        </div>
    </div>
</div>

<script>
    (function () {
        const modalElement = document.getElementById('confirmPayInvoiceModal');
        if (modalElement) {
            const modal = new bootstrap.Modal(modalElement);
            modal.show();

            // Focus amount
            setTimeout(() => {
                const amountInput = document.getElementById('amount_modal');
                if (amountInput) {
                    amountInput.focus();
                    amountInput.select();

                    // Formateo argentino para el monto
                    function formatAmountAR(value) {
                        // Eliminar todo excepto n√∫meros y coma
                        let cleaned = value.replace(/[^\d,]/g, '');

                        // Separar parte entera y decimal
                        let parts = cleaned.split(',');
                        let integerPart = parts[0];
                        let decimalPart = parts[1] || '';

                        // Limitar decimales a 2
                        if (decimalPart.length > 2) {
                            decimalPart = decimalPart.substring(0, 2);
                        }

                        // Agregar separadores de miles (punto)
                        integerPart = integerPart.replace(/\B(?=(\d{3})+(?!\d))/g, '.');

                        // Reconstruir
                        return decimalPart ? `${integerPart},${decimalPart}` : integerPart;
                    }

                    function parseAmountAR(value) {
                        // Convertir formato argentino a n√∫mero
                        return parseFloat(value.replace(/\./g, '').replace(',', '.')) || 0;
                    }

                    // Aplicar formateo al escribir
                    amountInput.addEventListener('input', function (e) {
                        const cursorPos = this.selectionStart;
                        const oldLength = this.value.length;

                        this.value = formatAmountAR(this.value);

                        // Ajustar cursor
                        const newLength = this.value.length;
                        const newCursorPos = cursorPos + (newLength - oldLength);
                        this.setSelectionRange(newCursorPos, newCursorPos);

                        // Actualizar campo oculto
                        const hiddenInput = document.getElementById('amount_hidden');
                        if (hiddenInput) {
                            hiddenInput.value = parseAmountAR(this.value);
                        }
                    });

                    // Validar al perder foco
                    amountInput.addEventListener('blur', function () {
                        const parsed = parseAmountAR(this.value);
                        if (parsed > 0) {
                            // Formatear con 2 decimales
                            this.value = parsed.toLocaleString('es-AR', {
                                minimumFractionDigits: 2,
                                maximumFractionDigits: 2
                            });

                            // Actualizar campo oculto
                            const hiddenInput = document.getElementById('amount_hidden');
                            if (hiddenInput) {
                                hiddenInput.value = parsed.toFixed(2);
                            }
                        }
                    });
                }
            }, 500);

            const form = document.getElementById('confirmPayForm');

            // Log HTMX configuration for debugging
            console.log('[PAYMENT] Form HTMX config:', {
                'hx-post': form.getAttribute('hx-post'),
                'hx-target': form.getAttribute('hx-target'),
                'hx-swap': form.getAttribute('hx-swap')
            });

            // Handle HTMX events to close modal
            form.addEventListener('htmx:afterRequest', function (evt) {
                console.log('[PAYMENT] afterRequest:', evt.detail);
                if (evt.detail.successful) {
                    console.log('[PAYMENT] Request successful, closing modal');
                    modal.hide();
                    // Remove modal from DOM after hide
                    modalElement.addEventListener('hidden.bs.modal', function () {
                        modalElement.remove();
                    });
                } else {
                    console.error('[PAYMENT] Request failed:', evt.detail);
                    // Re-enable button on error
                    const btn = document.getElementById('confirmPayBtn');
                    if (btn) {
                        btn.disabled = false;
                        btn.innerHTML = 'Registrar Pago';
                    }
                }
            });

            form.addEventListener('htmx:beforeRequest', function (evt) {
                console.log('[PAYMENT] beforeRequest - sending data:', new FormData(form));
                const btn = document.getElementById('confirmPayBtn');
                if (btn) {
                    btn.disabled = true;
                    btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span> Procesando...';
                }
            });

            // Handle HTTP errors (4xx, 5xx)
            form.addEventListener('htmx:responseError', function (evt) {
                console.error('[PAYMENT] HTTP Error:', evt.detail);
                const btn = document.getElementById('confirmPayBtn');
                if (btn) {
                    btn.disabled = false;
                    btn.innerHTML = 'Registrar Pago';
                }
                // Error should be displayed via HX-Retarget to #modal-errors
            });

            // Handle missing target error (e.g. when on list view)
            form.addEventListener('htmx:targetError', function (evt) {
                console.warn('[PAYMENT] Target error (expected on list view):', evt.detail);
                // If the target is missing but the request was successful (e.g. managed by HX-Refresh or side effects),
                // we should just close the modal.
                modal.hide();
                modalElement.addEventListener('hidden.bs.modal', function () {
                    modalElement.remove();
                });
            });

            // Clean up if closed manually
            modalElement.addEventListener('hidden.bs.modal', function () {
                modalElement.remove();
            });
        }
    })();
</script>