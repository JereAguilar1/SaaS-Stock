{% extends "base.html" %}

{% block title %}Nueva Boleta de Compra - Sistema de Gestión{% endblock %}

{% block page_title %}Nueva Boleta de Compra{% endblock %}

{% block content %}
<form method="POST" action="{{ url_for('invoices.create_invoice') }}">
    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: var(--spacing-6); margin-bottom: var(--spacing-6);">
        <!-- Header Section -->
        <div class="card-custom">
            <div class="card-header-custom" style="background-color: var(--color-primary); color: white;">
                <h5 class="card-title" style="color: white; margin: 0;">
                    <i class="bi bi-file-earmark-text"></i> Datos de la Boleta
                </h5>
            </div>
            <div class="card-body-custom">
                <!-- Supplier -->
                <div class="form-group">
                    <label for="supplier_id" class="form-label-custom">
                        Proveedor <span style="color: var(--color-danger);">*</span>
                    </label>
                    <select class="form-select-custom" id="supplier_id" name="supplier_id" required
                        hx-post="{{ url_for('invoices.update_draft_header') }}" hx-trigger="change">
                        <option value="">Seleccione proveedor...</option>
                        {% for supplier in suppliers %}
                        <option value="{{ supplier.id }}" {% if draft.supplier_id==supplier.id %}selected{% endif %}>
                            {{ supplier.name }}
                        </option>
                        {% endfor %}
                    </select>
                </div>

                <!-- Invoice Number -->
                <div class="form-group">
                    <label for="invoice_number" class="form-label-custom">
                        Número de Boleta <span style="color: var(--color-danger);">*</span>
                    </label>
                    <input type="text" class="form-input-custom" id="invoice_number" name="invoice_number"
                        value="{{ draft.invoice_number }}" required placeholder="000-00000000"
                        hx-post="{{ url_for('invoices.update_draft_header') }}" hx-trigger="blur" autocomplete="off">
                </div>

                <!-- Dates -->
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: var(--spacing-4);">
                    <div class="form-group">
                        <label for="invoice_date" class="form-label-custom">
                            Fecha Boleta <span style="color: var(--color-danger);">*</span>
                        </label>
                        <input type="date" class="form-input-custom" id="invoice_date" name="invoice_date"
                            value="{{ draft.invoice_date }}" required
                            hx-post="{{ url_for('invoices.update_draft_header') }}" hx-trigger="blur">
                    </div>
                    <div class="form-group">
                        <label for="due_date" class="form-label-custom">Vencimiento</label>
                        <input type="date" class="form-input-custom" id="due_date" name="due_date"
                            value="{{ draft.due_date }}" hx-post="{{ url_for('invoices.update_draft_header') }}"
                            hx-trigger="blur">
                        <div id="date-error" class="form-error-text"
                            style="display: none; margin-top: var(--spacing-1);">
                            <i class="bi bi-exclamation-circle"></i> La fecha de vencimiento debe ser posterior a la
                            fecha de la boleta.
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Add Item Section -->
        <div class="card-custom">
            <div class="card-header-custom" style="background-color: var(--color-primary); color: white;">
                <h5 class="card-title" style="color: white; margin: 0;">
                    <i class="bi bi-plus-circle"></i> Agregar Ítem
                </h5>
            </div>
            <div class="card-body-custom">
                <div class="form-group">
                    <label for="product_search_input" class="form-label-custom">Producto</label>
                    <div style="position: relative;">
                        <!-- Updated Input: remove list attribute, ensure autocomplete off -->
                        <input type="text" class="form-input-custom" id="product_search_input"
                            placeholder="Buscar por Nombre, SKU o Código de Barras..." autocomplete="off">
                        <input type="hidden" id="product_id" name="product_id" required>

                        <!-- Custom Results Container -->
                        <ul id="product_search_results" class="list-group" style="display: none; position: absolute; top: 100%; left: 0; right: 0; z-index: 1000; 
                                   max-height: 300px; overflow-y: auto; background: white; border: 1px solid #ddd; 
                                   box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
                                   margin-top: 4px; border-radius: 4px; padding: 0; list-style: none;">
                        </ul>
                    </div>
                </div>

                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: var(--spacing-4);">
                    <div class="form-group">
                        <label for="qty" class="form-label-custom">Cantidad</label>
                        <input type="number" class="form-input-custom" id="qty" name="qty" min="1" step="1"
                            placeholder="1">
                    </div>
                    <div class="form-group">
                        <label for="unit_cost" class="form-label-custom">Costo Unitario</label>
                        <div style="position: relative;">
                            <span
                                style="position: absolute; left: 12px; top: 50%; transform: translateY(-50%); color: var(--color-text-muted);">$</span>
                            <input type="text" class="form-input-custom" id="unit_cost" name="unit_cost_display"
                                value="0" title="Ingrese el costo unitario con hasta dos decimales (ej: 5.000,50)"
                                onfocus="if(this.value === '0' || this.value === '0.00') this.value = '';"
                                style="padding-left: 28px;">
                            <input type="hidden" id="unit_cost_hidden" name="unit_cost" value="0">
                        </div>
                    </div>
                </div>

                <button type="submit" class="btn-custom btn-secondary-custom"
                    style="width: 100%; justify-content: center; height: 42px; margin-top: var(--spacing-2); background-color: var(--color-primary); color: white; border: none;"
                    formaction="{{ url_for('invoices.add_draft_line') }}">
                    <i class="bi bi-plus-circle"></i> Agregar a la Lista
                </button>
            </div>
        </div>
    </div>

    <!-- Lines Section -->
    <div class="card-custom" style="margin-bottom: var(--spacing-6);">
        <div class="card-header-custom">
            <h5 class="card-title">Ítems de la Boleta</h5>
        </div>
        {% if draft.lines %}
        <div class="table-container">
            <table class="table-custom">
                <thead>
                    <tr>
                        <th>Producto</th>
                        <th>UOM</th>
                        <th style="text-align: right;">Cantidad</th>
                        <th style="text-align: right;">Costo Unit.</th>
                        <th style="text-align: right;">Subtotal</th>
                        <th style="text-align: center; width: 60px;"></th>
                    </tr>
                </thead>
                <tbody>
                    {% for line in draft.lines %}
                    {% set product = products | selectattr('id', 'equalto', line.product_id) | first %}
                    {% set line_total = line.qty * line.unit_cost %}
                    <tr>
                        <td><strong style="color: var(--color-text-primary);">{{ product.name if product else 'Producto
                                no encontrado' }}</strong></td>
                        <td>{{ product.uom.symbol if product else '-' }}</td>
                        <td style="text-align: right;">{{ line.qty|int }}</td>
                        <td style="text-align: right;">${{ line.unit_cost|money_ar }}</td>
                        <td style="text-align: right;"><strong style="color: var(--color-text-primary);">${{
                                line_total|money_ar }}</strong></td>
                        <td style="text-align: center;">
                            <button type="submit" class="btn-custom btn-danger-custom btn-sm"
                                formaction="{{ url_for('invoices.remove_draft_line', product_id=line.product_id) }}"
                                title="Eliminar"
                                style="display: inline-flex; justify-content: center; align-items: center; width: 32px; height: 32px; padding: 0;">
                                <i class="bi bi-trash"></i>
                            </button>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
                <tfoot style="background-color: var(--color-bg-muted);">
                    <tr>
                        <td colspan="4"
                            style="text-align: right; padding: var(--spacing-4); font-weight: var(--font-weight-bold);">
                            TOTAL:</td>
                        <td style="text-align: right; padding: var(--spacing-4);">
                            <span
                                style="font-size: var(--font-size-xl); color: var(--color-primary); font-weight: var(--font-weight-bold);">${{
                                total_amount|money_ar }}</span>
                        </td>
                        <td></td>
                    </tr>
                </tfoot>
            </table>
        </div>

        <div class="card-footer-custom" style="display: flex; justify-content: space-between;">
            <a href="{{ url_for('invoices.list_invoices') }}" class="btn-custom btn-secondary-custom">
                <i class="bi bi-x-circle"></i> Cancelar
            </a>
            <div style="display: flex; align-items: center; gap: var(--spacing-4);">
                <div id="preview-loading" class="htmx-indicator" style="display: none; color: var(--color-primary);">
                    <div class="spinner-border spinner-border-sm" role="status">
                        <span class="visually-hidden">Cargando...</span>
                    </div>
                </div>
                <button type="button" class="btn-custom btn-primary-custom"
                    style="padding: var(--spacing-2) var(--spacing-6); font-size: var(--font-size-lg);"
                    hx-get="{{ url_for('invoices.confirm_create_preview') }}"
                    hx-target="#invoice-create-modal-container" hx-swap="innerHTML" hx-indicator="#preview-loading">
                    <i class="bi bi-eye"></i> Revisar y Confirmar
                </button>
            </div>
        </div>
        {% else %}
        <div class="card-body-custom">
            <div class="empty-state">
                <i class="empty-state-icon bi bi-cart-x"></i>
                <div class="empty-state-title">No hay ítems agregados</div>
                <p class="empty-state-description">Agregue productos desde el panel de la derecha para crear la boleta.
                </p>
            </div>
        </div>
        {% endif %}
    </div>
</form>

<!-- Modal Container for HTMX -->
<div id="invoice-create-modal-container"></div>

{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function () {
        const invoiceDateInput = document.getElementById('invoice_date');
        const dueDateInput = document.getElementById('due_date');
        const dateError = document.getElementById('date-error');
        const submitBtn = document.querySelector('button[formaction*="add_draft_line"]');
        const confirmBtn = document.querySelector('button[hx-get*="confirm_create_preview"]');

        function formatDate(date) {
            const yyyy = date.getFullYear();
            let mm = date.getMonth() + 1;
            let dd = date.getDate();
            if (dd < 10) dd = '0' + dd;
            if (mm < 10) mm = '0' + mm;
            return yyyy + '-' + mm + '-' + dd;
        }

        // 1. Establecer valor por defecto para Fecha de Boleta si está vacío
        const today = new Date();
        if (!invoiceDateInput.value) {
            invoiceDateInput.value = formatDate(today);
        }

        // 2. Lógica de Validación
        function validateDates() {
            const invDate = new Date(invoiceDateInput.value);
            const dueDate = new Date(dueDateInput.value);

            // Solo validar si ambas tienen valor
            if (invoiceDateInput.value && dueDateInput.value) {
                if (dueDate <= invDate) {
                    // Mostrar error
                    dateError.style.display = 'block';
                    dueDateInput.classList.add('is-invalid');

                    // Bloquear acciones
                    if (submitBtn) submitBtn.disabled = true;
                    if (confirmBtn) confirmBtn.disabled = true;
                } else {
                    // Ocultar error
                    dateError.style.display = 'none';
                    dueDateInput.classList.remove('is-invalid');

                    // Habilitar acciones
                    if (submitBtn) submitBtn.disabled = false;
                    if (confirmBtn) confirmBtn.disabled = false;
                }
            }
        }

        // Validar al cargar y al cambiar
        validateDates();
        invoiceDateInput.addEventListener('change', validateDates);
        dueDateInput.addEventListener('change', validateDates);

        // Validar al cargar y al cambiar
        validateDates();
        invoiceDateInput.addEventListener('change', validateDates);
        dueDateInput.addEventListener('change', validateDates);

        // 3. Autocomplete Inteligente para Productos (Custom Typeahead)
        const searchInput = document.getElementById('product_search_input');
        const searchResults = document.getElementById('product_search_results');
        const hiddenIdInput = document.getElementById('product_id');
        const unitCostInput = document.getElementById('unit_cost');

        // Debounce helper
        function debounce(func, wait) {
            let timeout;
            return function (...args) {
                clearTimeout(timeout);
                timeout = setTimeout(() => func.apply(this, args), wait);
            };
        }

        // Search logic
        const performSearch = debounce(async function () {
            const query = searchInput.value.trim();

            // Allow empty query to fetch default list ("Show All" behavior)
            // if (query.length < 2) { ... } -> REMOVED

            try {
                const response = await fetch(`/invoices/products/search?q=${encodeURIComponent(query)}`);
                if (!response.ok) throw new Error('Error en búsqueda');
                const products = await response.json();

                renderResults(products);
            } catch (error) {
                console.error('Search error:', error);
                searchResults.style.display = 'none';
            }
        }, 300);

        // Render logic
        function renderResults(products) {
            searchResults.innerHTML = '';

            if (products.length === 0) {
                // If query was not empty but no results found
                if (searchInput.value.trim() !== '') {
                    const li = document.createElement('li');
                    li.style.padding = '8px 12px';
                    li.style.color = '#6c757d';
                    li.textContent = 'No se encontraron productos';
                    searchResults.appendChild(li);
                    searchResults.style.display = 'block';
                } else {
                    // Empty query and no products (empty inventory)
                    const li = document.createElement('li');
                    li.style.padding = '8px 12px';
                    li.style.color = '#6c757d';
                    li.textContent = 'No hay productos disponibles';
                    searchResults.appendChild(li);
                    searchResults.style.display = 'block';
                }
            } else {
                products.forEach(product => {
                    const li = document.createElement('li');
                    li.style.padding = '8px 12px';
                    li.style.cursor = 'pointer';
                    li.style.borderBottom = '1px solid #f0f0f0';
                    li.style.color = '#333'; // Ensure visibility

                    // Hover effect via JS since inline styles are used
                    li.onmouseover = () => li.style.background = '#f8f9fa';
                    li.onmouseout = () => li.style.background = 'white';

                    li.innerHTML = `
                        <div style="font-weight: 600;">${product.name}</div>
                    `;

                    li.addEventListener('click', () => selectProduct(product));
                    searchResults.appendChild(li);
                });
                searchResults.style.display = 'block';
            }
        }

        // Selection logic
        function selectProduct(product) {
            searchInput.value = product.name;
            hiddenIdInput.value = product.id;

            // Auto-fill cost if empty or zero
            if (unitCostInput && (unitCostInput.value === "0.00" || unitCostInput.value === "0" || unitCostInput.value === "")) {
                // Use product.cost instead of product.sale_price
                if (typeof formatSmartAr === 'function') {
                    unitCostInput.value = formatSmartAr(product.cost);

                    // Also trigger input event to update hidden cost input logic if present
                    unitCostInput.dispatchEvent(new Event('input', { bubbles: true }));
                    unitCostInput.dispatchEvent(new Event('blur', { bubbles: true }));
                } else {
                    unitCostInput.value = product.cost;
                }
            }

            searchResults.style.display = 'none';
        }

        // Event Listeners
        searchInput.addEventListener('input', function () {
            // Clear ID on input change to force selection
            hiddenIdInput.value = '';
            performSearch();
        });

        // NEW: Trigger search on focus ("Show All" behavior)
        searchInput.addEventListener('focus', function () {
            // If already has a selected value (ID is set), maybe don't pop up?
            // User requirement: "When making click... or when empty"
            // Let's just trigger it. If they want to change it, they see options.
            if (hiddenIdInput.value === '') {
                performSearch();
            } else {
                // If they have something selected, they might want to see the list again if they clear it
                // Or if they just clicked it.
                // Let's trigger it.
                performSearch();
            }
        });

        // Hide results when clicking outside
        document.addEventListener('click', function (e) {
            if (!searchInput.contains(e.target) && !searchResults.contains(e.target)) {
                searchResults.style.display = 'none';
            }
        });


        // Limpiar input al agregar (opcional, si se recarga la página no hace falta, pero si es HTMX sí)

        // ========== FORMATO ARGENTINO PARA COSTO UNITARIO ==========
        /**
         * Formatea un número en estilo argentino "Smart"
         */
        function formatSmartAr(value) {
            if (value === null || value === undefined || value === '' || isNaN(value)) return '';

            const num = parseFloat(value);
            if (num === 0) return '0';

            // Separar parte entera y decimal
            let [integerPart, decimalPart] = num.toFixed(2).split('.');

            // Eliminar ceros finales en decimales
            decimalPart = decimalPart.replace(/0+$/, '');

            // Formatear parte entera con separador de miles
            integerPart = integerPart.replace(/\B(?=(\d{3})+(?!\d))/g, '.');

            // Construir resultado
            return decimalPart ? `${integerPart},${decimalPart}` : integerPart;
        }

        /**
         * Convierte formato argentino a número
         */
        function parseArToNumber(value) {
            if (!value || value === '') return 0;
            // Eliminar puntos (separador de miles) y reemplazar coma por punto
            const cleaned = value.toString().replace(/\./g, '').replace(',', '.');
            return parseFloat(cleaned) || 0;
        }

        const unitCostFormatInput = document.getElementById('unit_cost');
        const unitCostHidden = document.getElementById('unit_cost_hidden');
        const invoiceFormSubmit = document.querySelector('form');

        // Formatear al perder el foco
        if (unitCostFormatInput) {
            unitCostFormatInput.addEventListener('blur', function () {
                if (this.value && this.value !== '') {
                    const numValue = parseArToNumber(this.value);
                    if (!isNaN(numValue) && numValue > 0) {
                        this.value = formatSmartAr(numValue);
                        unitCostHidden.value = numValue.toFixed(2);
                    } else if (this.value === '') {
                        this.value = '0';
                        unitCostHidden.value = '0';
                    }
                }
            });

            // Actualizar hidden input mientras escribe
            unitCostFormatInput.addEventListener('input', function () {
                const numValue = parseArToNumber(this.value);
                unitCostHidden.value = isNaN(numValue) ? '0' : numValue.toFixed(2);
            });
        }

        // Antes de enviar el formulario, asegurar que el hidden tenga el valor correcto
        if (invoiceFormSubmit && unitCostFormatInput && unitCostHidden) {
            invoiceFormSubmit.addEventListener('submit', function (e) {
                const numValue = parseArToNumber(unitCostFormatInput.value);
                unitCostHidden.value = isNaN(numValue) ? '0' : numValue.toFixed(2);
            });
        }
    });
</script>
{% endblock %}