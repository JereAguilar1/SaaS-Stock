{% extends "base.html" %}

{% block title %}Detalle de Venta #{{ sale.id }}{% endblock %}

{% block page_title %}Venta #{{ sale.id }}{% endblock %}

{% block topbar_actions %}
<a href="{{ url_for('sales.list_sales') }}" class="btn-custom btn-secondary-custom">
    <i class="bi bi-arrow-left"></i> Volver al Listado
</a>
{% if sale.status.value == 'CONFIRMED' or sale.status == 'CONFIRMED' %}
<a href="{{ url_for('sales.edit_sale_form', sale_id=sale.id) }}" class="btn-custom btn-warning-custom">
    <i class="bi bi-pencil"></i> Editar/Ajustar
</a>
{% endif %}
{% endblock %}

{% block content %}
<div style="display: grid; grid-template-columns: 2fr 1fr; gap: var(--spacing-6);">
    <!-- Left Column: Products -->
    <div>
        <div class="card-custom">
            <div class="card-header-custom">
                <h2 class="card-title">
                    <i class="bi bi-cart-check"></i> Productos Vendidos
                </h2>
            </div>
            <div class="table-container">
                <table class="table-custom">
                    <thead>
                        <tr>
                            <th>Producto</th>
                            <th style="text-align: center;">Cantidad</th>
                            <th style="text-align: right;">Precio Unit.</th>
                            <th style="text-align: right;">Subtotal</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for line in sale.lines %}
                        <tr>
                            <td>
                                <strong style="color: var(--color-text-primary);">{{ line.product.name }}</strong>
                                <br>
                                <small style="color: var(--color-text-muted);">
                                    SKU: {{ line.product.sku or '-' }} |
                                    {{ line.product.uom.symbol if line.product.uom else '-' }}
                                </small>
                            </td>
                            <td style="text-align: center;">
                                <span class="badge-custom badge-secondary">{{ line.qty }}</span>
                            </td>
                            <td style="text-align: right;">${{ line.unit_price|money_ar }}</td>
                            <td style="text-align: right;">
                                <strong style="color: var(--color-text-primary);">${{ line.line_total|money_ar
                                    }}</strong>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                    <tfoot style="background-color: var(--color-bg-muted);">
                        <tr>
                            <td colspan="3"
                                style="text-align: right; padding: var(--spacing-4); font-weight: var(--font-weight-bold);">
                                TOTAL:</td>
                            <td style="text-align: right; padding: var(--spacing-4);">
                                <span
                                    style="font-size: var(--font-size-xl); font-weight: var(--font-weight-bold); color: var(--color-success);">
                                    ${{ sale.total|money_ar }}
                                </span>
                            </td>
                        </tr>
                    </tfoot>
                </table>
            </div>
        </div>

        <div style="margin-top: var(--spacing-6);">
            <div class="alert-custom alert-info">
                <i class="alert-custom-icon bi bi-info-circle"></i>
                <div class="alert-custom-content">
                    <strong>Nota:</strong>
                    Esta venta ya fue procesada (stock descontado y registro contable creado).
                    {% if sale.status.value == 'CONFIRMED' or sale.status == 'CONFIRMED' %}
                    Si necesita corregir cantidades o agregar/eliminar productos, use el botón
                    <strong>"Editar/Ajustar"</strong>. Esto creará movimientos de ajuste para mantener la trazabilidad.
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Right Column: Info -->
    <div>
        <div class="card-custom">
            <div class="card-header-custom"
                style="background-color: var(--color-primary); color: var(--color-text-inverse);">
                <h2 class="card-title" style="color: var(--color-text-inverse); margin: 0;">Resumen de Venta</h2>
            </div>
            <div class="card-body-custom">
                <div
                    style="text-align: center; margin-bottom: var(--spacing-6); padding-bottom: var(--spacing-6); border-bottom: 1px solid var(--color-border-light);">
                    <div
                        style="font-size: var(--font-size-sm); color: var(--color-text-secondary); margin-bottom: var(--spacing-1);">
                        Total Venta</div>
                    <div
                        style="font-size: var(--font-size-4xl); color: var(--color-primary); font-weight: var(--font-weight-bold);">
                        ${{ sale.total|money_ar }}
                    </div>
                    <div style="margin-top: var(--spacing-3);">
                        {% if sale.status.value == 'CONFIRMED' or sale.status == 'CONFIRMED' %}
                        <span class="badge-custom badge-success">Confirmada</span>
                        {% elif sale.status.value == 'CANCELLED' or sale.status == 'CANCELLED' %}
                        <span class="badge-custom badge-danger">Cancelada</span>
                        {% else %}
                        <span class="badge-custom badge-secondary">{{ sale.status.value if sale.status.value else
                            sale.status }}</span>
                        {% endif %}
                    </div>
                </div>

                {% if sale.payment_method == 'CUENTA_CORRIENTE' %}
                <!-- VIEW VERSION: Hidden when printing -->
                <div class="mt-4 p-3 rounded d-print-none"
                    style="background-color: var(--color-bg-muted); border: 1px solid var(--color-border-light);">
                    <h6 class="mb-3" style="color: var(--color-text-primary); font-size: 0.95rem;">
                        <i class="bi bi-wallet2 text-primary"></i> Estado de Cuenta Corriente
                    </h6>

                    <div class="d-flex justify-content-between mb-2" style="font-size: 0.9rem;">
                        <span style="color: var(--color-text-muted);">Total de la Venta:</span>
                        <span class="fw-bold" style="color: var(--color-text-primary);">$ {{ sale.total | money_ar
                            }}</span>
                    </div>

                    <div class="d-flex justify-content-between mb-2" style="font-size: 0.9rem;">
                        <span style="color: var(--color-text-muted);">Monto Pagado:</span>
                        <span class="text-success fw-bold">$ {{ sale.amount_paid | money_ar }}</span>
                    </div>

                    <div style="border-top: 1px dashed var(--color-border-light); margin: 8px 0;"></div>

                    <div class="d-flex justify-content-between align-items-center mb-3" style="font-size: 0.95rem;">
                        <span style="color: var(--color-text-muted);">Deuda Pendiente (esta venta):</span>
                        <span class="text-danger fw-bold text-end" style="white-space: nowrap;">
                            $ {{ (sale.total - sale.amount_paid) | money_ar }}
                        </span>
                    </div>

                    {% if sale.customer %}
                    <div class="px-3 py-2 rounded d-flex justify-content-between align-items-center"
                        style="background-color: rgba(0,0,0,0.03); border: 1px solid var(--color-border-light);">
                        <span style="font-size: 0.85rem; color: var(--color-text-secondary);">
                            <i class="bi bi-person-badge"></i> Deuda Total del Cliente:
                        </span>
                        <span class="fw-bold text-end"
                            style="color: var(--color-danger); font-size: 1.1rem; white-space: nowrap;">
                            $ {{ total_debt | money_ar }}
                        </span>
                    </div>
                    {% endif %}
                </div>

                <!-- PRINT VERSION: Hidden in UI, visible when printing -->
                <div class="d-none d-print-block"
                    style="border: 2px dashed #000; padding: 10px; margin-top: 15px; text-align: center;">
                    <h4 style="margin: 0 0 5px 0;">ESTADO DE CUENTA CORRIENTE</h4>

                    <div style="display: flex; justify-content: space-between; margin-bottom: 3px;">
                        <span>Total de esta venta:</span>
                        <strong>$ {{ sale.total | money_ar }}</strong>
                    </div>

                    <div style="display: flex; justify-content: space-between; margin-bottom: 3px;">
                        <span>Abonado hoy:</span>
                        <strong>$ {{ sale.amount_paid | money_ar }}</strong>
                    </div>

                    <div style="display: flex; justify-content: space-between; margin-bottom: 3px;">
                        <span>Deuda Pendiente (esta venta):</span>
                        <span class="text-danger fw-bold text-end" style="white-space: nowrap; color: #dc3545;">
                            $ {{ (sale.total - sale.amount_paid) | money_ar }}
                        </span>
                    </div>

                    <div style="border-top: 1px solid #000; margin: 8px 0;"></div>

                    {% if sale.customer %}
                    <div style="display: flex; justify-content: space-between; font-size: 1.1em;">
                        <strong>SALDO TOTAL ADEUDADO:</strong>
                        <strong style="color: #990000; white-space: nowrap;">$ {{ total_debt | money_ar }}</strong>
                    </div>
                    <div style="text-align: left; font-size: 0.8em; margin-top: 5px; color: #555;">
                        * El saldo total incluye esta venta y compras anteriores no canceladas.
                    </div>
                    {% endif %}
                </div>
                {% endif %}

                <dl
                    style="display: grid; grid-template-columns: auto 1fr; gap: var(--spacing-3) var(--spacing-6); margin: 0;">
                    <dt style="color: var(--color-text-secondary);">ID Venta:</dt>
                    <dd style="font-weight: var(--font-weight-bold);">#{{ sale.id }}</dd>

                    <dt style="color: var(--color-text-secondary);">Fecha:</dt>
                    <dd>{{ sale.datetime|datetime_ar }}</dd>

                    <!-- User and other metadata could go here -->
                </dl>
            </div>
            <div class="card-footer-custom" style="justify-content: center;">
                <button class="btn-custom btn-secondary-custom" onclick="window.print()">
                    <i class="bi bi-printer"></i> Imprimir Comprobante
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
    @media print {
        body * {
            visibility: hidden;
        }

        .card-custom,
        .card-custom * {
            visibility: visible;
        }

        .card-custom {
            position: absolute;
            left: 0;
            top: 0;
            width: 100%;
            box-shadow: none;
            border: 1px solid #ccc;
        }

        .btn-custom,
        .alert-custom {
            display: none !important;
        }
    }
</style>
{% endblock %}