{% extends "base.html" %}

{% block title %}Detalle de Venta #{{ sale.id }}{% endblock %}

{% block page_title %}Venta #{{ sale.id }}{% endblock %}

{% block topbar_actions %}
<a href="{{ url_for('sales.list_sales') }}" class="btn-custom btn-secondary-custom">
    <i class="bi bi-arrow-left"></i> Volver al Listado
</a>
{% if sale.status.value == 'CONFIRMED' or sale.status == 'CONFIRMED' %}
<a href="{{ url_for('sales.edit_sale_form', sale_id=sale.id) }}" class="btn-custom btn-warning-custom">
    <i class="bi bi-pencil"></i> Editar/Ajustar
</a>
{% endif %}
{% endblock %}

{% block content %}
<div style="display: grid; grid-template-columns: 2fr 1fr; gap: var(--spacing-6);">
    <!-- Left Column: Products -->
    <div>
        <div class="card-custom">
            <div class="card-header-custom">
                <h2 class="card-title">
                    <i class="bi bi-cart-check"></i> Productos Vendidos
                </h2>
            </div>
            <div class="table-container">
                <table class="table-custom">
                    <thead>
                        <tr>
                            <th>Producto</th>
                            <th style="text-align: center;">Cantidad</th>
                            <th style="text-align: right;">Precio Unit.</th>
                            <th style="text-align: right;">Subtotal</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for line in sale.lines %}
                        <tr>
                            <td>
                                <strong style="color: var(--color-text-primary);">{{ line.product.name }}</strong>
                                <br>
                                <small style="color: var(--color-text-muted);">
                                    SKU: {{ line.product.sku or '-' }} |
                                    {{ line.product.uom.symbol if line.product.uom else '-' }}
                                </small>
                            </td>
                            <td style="text-align: center;">
                                <span class="badge-custom badge-secondary">{{ line.qty }}</span>
                            </td>
                            <td style="text-align: right;">${{ "%.2f"|format(line.unit_price) }}</td>
                            <td style="text-align: right;">
                                <strong style="color: var(--color-text-primary);">${{ "%.2f"|format(line.line_total)
                                    }}</strong>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                    <tfoot style="background-color: var(--color-bg-muted);">
                        <tr>
                            <td colspan="3"
                                style="text-align: right; padding: var(--spacing-4); font-weight: var(--font-weight-bold);">
                                TOTAL:</td>
                            <td style="text-align: right; padding: var(--spacing-4);">
                                <span
                                    style="font-size: var(--font-size-xl); font-weight: var(--font-weight-bold); color: var(--color-success);">
                                    ${{ "%.2f"|format(sale.total) }}
                                </span>
                            </td>
                        </tr>
                    </tfoot>
                </table>
            </div>
        </div>

        <div style="margin-top: var(--spacing-6);">
            <div class="alert-custom alert-info">
                <i class="alert-custom-icon bi bi-info-circle"></i>
                <div class="alert-custom-content">
                    <strong>Nota:</strong>
                    Esta venta ya fue procesada (stock descontado y registro contable creado).
                    {% if sale.status.value == 'CONFIRMED' or sale.status == 'CONFIRMED' %}
                    Si necesita corregir cantidades o agregar/eliminar productos, use el botón
                    <strong>"Editar/Ajustar"</strong>. Esto creará movimientos de ajuste para mantener la trazabilidad.
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Right Column: Info -->
    <div>
        <div class="card-custom">
            <div class="card-header-custom"
                style="background-color: var(--color-primary); color: var(--color-text-inverse);">
                <h2 class="card-title" style="color: var(--color-text-inverse); margin: 0;">Resumen de Venta</h2>
            </div>
            <div class="card-body-custom">
                <div
                    style="text-align: center; margin-bottom: var(--spacing-6); padding-bottom: var(--spacing-6); border-bottom: 1px solid var(--color-border-light);">
                    <div
                        style="font-size: var(--font-size-sm); color: var(--color-text-secondary); margin-bottom: var(--spacing-1);">
                        Total Venta</div>
                    <div
                        style="font-size: var(--font-size-4xl); color: var(--color-primary); font-weight: var(--font-weight-bold);">
                        ${{ "%.2f"|format(sale.total) }}
                    </div>
                    <div style="margin-top: var(--spacing-3);">
                        {% if sale.status.value == 'CONFIRMED' or sale.status == 'CONFIRMED' %}
                        <span class="badge-custom badge-success">Confirmada</span>
                        {% elif sale.status.value == 'CANCELLED' or sale.status == 'CANCELLED' %}
                        <span class="badge-custom badge-danger">Cancelada</span>
                        {% else %}
                        <span class="badge-custom badge-secondary">{{ sale.status.value if sale.status.value else
                            sale.status }}</span>
                        {% endif %}
                    </div>
                </div>

                <dl
                    style="display: grid; grid-template-columns: auto 1fr; gap: var(--spacing-3) var(--spacing-6); margin: 0;">
                    <dt style="color: var(--color-text-secondary);">ID Venta:</dt>
                    <dd style="font-weight: var(--font-weight-bold);">#{{ sale.id }}</dd>

                    <dt style="color: var(--color-text-secondary);">Fecha:</dt>
                    <dd>{{ sale.datetime|datetime_ar }}</dd>

                    <!-- User and other metadata could go here -->
                </dl>
            </div>
            <div class="card-footer-custom" style="justify-content: center;">
                <button class="btn-custom btn-secondary-custom" onclick="window.print()">
                    <i class="bi bi-printer"></i> Imprimir Comprobante
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
    @media print {
        body * {
            visibility: hidden;
        }

        .card-custom,
        .card-custom * {
            visibility: visible;
        }

        .card-custom {
            position: absolute;
            left: 0;
            top: 0;
            width: 100%;
            box-shadow: none;
            border: 1px solid #ccc;
        }

        .btn-custom,
        .alert-custom {
            display: none !important;
        }
    }
</style>
{% endblock %}