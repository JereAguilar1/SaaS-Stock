<!-- Edit Sale Confirmation Modal -->
<div class="modal fade" id="confirmEditSaleModal" tabindex="-1" aria-labelledby="confirmEditSaleModalLabel"
    aria-hidden="true" data-bs-backdrop="static">
    <div class="modal-dialog modal-xl modal-dialog-centered modal-dialog-scrollable">
        <div class="modal-content"
            style="border-radius: var(--radius-xl); border: none; box-shadow: var(--shadow-2xl);">
            <!-- Header -->
            <div class="modal-header"
                style="background-color: var(--color-warning); color: var(--color-text-primary); border-bottom: 1px solid rgba(0,0,0,0.05);">
                <h5 class="modal-title" id="confirmEditSaleModalLabel"
                    style="font-weight: var(--font-weight-bold); display: flex; align-items: center; gap: var(--spacing-2);">
                    <i class="bi bi-exclamation-triangle"></i> Confirmar Corrección de Venta #{{ sale_id }}
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
            </div>

            <!-- Body -->
            <div class="modal-body" style="background-color: var(--color-bg-body); padding: var(--spacing-6);">
                <!-- Warning Alert -->
                <div class="alert-custom alert-warning" style="margin-bottom: var(--spacing-6);">
                    <i class="alert-custom-icon bi bi-info-circle"></i>
                    <div class="alert-custom-content">
                        <strong>Importante:</strong>
                        Esta corrección generará:
                        <ul
                            style="margin: var(--spacing-1) 0 0 0; padding-left: var(--spacing-4); font-size: var(--font-size-sm);">
                            <li>Movimiento de stock tipo <strong>ADJUST</strong></li>
                            <li>Asiento contable compensatorio en el libro mayor</li>
                        </ul>
                    </div>
                </div>

                <!-- Stock Issues (if any) -->
                {% if changes.stock_issues %}
                <div class="alert-custom alert-danger" style="margin-bottom: var(--spacing-6);">
                    <i class="alert-custom-icon bi bi-x-circle"></i>
                    <div class="alert-custom-content">
                        <strong>Stock Insuficiente:</strong>
                        <ul
                            style="margin: var(--spacing-2) 0 0 0; padding-left: var(--spacing-4); font-size: var(--font-size-sm);">
                            {% for issue in changes.stock_issues %}
                            <li>
                                <strong>{{ issue.product_name }}</strong>:
                                Necesita {{ issue.needed }}, disponible: {{ issue.available }}
                            </li>
                            {% endfor %}
                        </ul>
                        <p style="margin: var(--spacing-2) 0 0 0; font-weight: bold;">No se puede aplicar esta
                            corrección.</p>
                    </div>
                </div>
                {% endif %}

                <!-- Changes Summary -->
                <div class="card-custom" style="margin-bottom: var(--spacing-6);">
                    <div class="card-header-custom" style="background-color: var(--color-bg-surface);">
                        <h6 class="card-title" style="font-size: var(--font-size-sm);">
                            <i class="bi bi-pencil-square"></i> Resumen de Cambios
                        </h6>
                    </div>
                    <div class="card-body-custom">
                        {% if changes.added %}
                        <h6 style="color: var(--color-success); margin-bottom: var(--spacing-2);">
                            <i class="bi bi-plus-circle"></i> Productos Agregados ({{ changes.added|length }})
                        </h6>
                        <ul style="margin-bottom: var(--spacing-4); font-size: var(--font-size-sm);">
                            {% for item in changes.added %}
                            <li>
                                <strong>{{ item.product_name }}</strong>:
                                {{ item.qty }} × ${{ "%.2f"|format(item.unit_price) }} =
                                <strong>${{ "%.2f"|format(item.subtotal) }}</strong>
                            </li>
                            {% endfor %}
                        </ul>
                        {% endif %}

                        {% if changes.removed %}
                        <h6 style="color: var(--color-danger); margin-bottom: var(--spacing-2);">
                            <i class="bi bi-dash-circle"></i> Productos Eliminados ({{ changes.removed|length }})
                        </h6>
                        <ul style="margin-bottom: var(--spacing-4); font-size: var(--font-size-sm);">
                            {% for item in changes.removed %}
                            <li>
                                <strong>{{ item.product_name }}</strong>:
                                {{ item.qty }} × ${{ "%.2f"|format(item.unit_price) }} =
                                <strong>${{ "%.2f"|format(item.subtotal) }}</strong>
                            </li>
                            {% endfor %}
                        </ul>
                        {% endif %}

                        {% if changes.modified %}
                        <h6 style="color: var(--color-primary); margin-bottom: var(--spacing-2);">
                            <i class="bi bi-arrow-left-right"></i> Cantidades Modificadas ({{ changes.modified|length
                            }})
                        </h6>
                        <ul style="margin: 0; font-size: var(--font-size-sm);">
                            {% for item in changes.modified %}
                            <li>
                                <strong>{{ item.product_name }}</strong>:
                                {{ item.old_qty }} → {{ item.new_qty }}
                                {% if item.delta_qty > 0 %}
                                <span class="badge-custom badge-success">+{{ item.delta_qty }}</span>
                                {% else %}
                                <span class="badge-custom badge-danger">{{ item.delta_qty }}</span>
                                {% endif %}
                            </li>
                            {% endfor %}
                        </ul>
                        {% endif %}
                    </div>
                </div>

                <!-- Before/After Tables -->
                <div
                    style="display: grid; grid-template-columns: 1fr 1fr; gap: var(--spacing-6); margin-bottom: var(--spacing-6);">
                    <!-- Before -->
                    <div class="card-custom" style="border: 1px solid var(--color-border-light);">
                        <div class="card-header-custom" style="background-color: var(--color-bg-muted);">
                            <h6 class="card-title" style="font-size: var(--font-size-sm);">
                                <i class="bi bi-clock-history"></i> Antes
                            </h6>
                        </div>
                        <div class="table-container">
                            <table class="table-custom">
                                <thead>
                                    <tr>
                                        <th>Producto</th>
                                        <th style="text-align: center;">Qty</th>
                                        <th style="text-align: right;">Subtotal</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for line in old_lines %}
                                    <tr>
                                        <td>
                                            <small>{{ line.product_name }}</small>
                                        </td>
                                        <td style="text-align: center;">{{ line.qty }}</td>
                                        <td style="text-align: right;">${{ "%.2f"|format(line.subtotal) }}</td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                                <tfoot style="background-color: var(--color-bg-muted);">
                                    <tr>
                                        <td colspan="2"><strong>Total:</strong></td>
                                        <td style="text-align: right;"><strong>${{ "%.2f"|format(old_total) }}</strong>
                                        </td>
                                    </tr>
                                </tfoot>
                            </table>
                        </div>
                    </div>

                    <!-- After -->
                    <div class="card-custom" style="border: 1px solid var(--color-success);">
                        <div class="card-header-custom" style="background-color: var(--color-success); color: white;">
                            <h6 class="card-title" style="font-size: var(--font-size-sm); color: white;">
                                <i class="bi bi-arrow-right-circle"></i> Después
                            </h6>
                        </div>
                        <div class="table-container">
                            <table class="table-custom">
                                <thead>
                                    <tr>
                                        <th>Producto</th>
                                        <th style="text-align: center;">Qty</th>
                                        <th style="text-align: right;">Subtotal</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for line in new_lines %}
                                    <tr>
                                        <td>
                                            <small>{{ line.product_name }}</small>
                                        </td>
                                        <td style="text-align: center;">{{ line.qty }}</td>
                                        <td style="text-align: right;">${{ "%.2f"|format(line.subtotal) }}</td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                                <tfoot style="background-color: var(--color-bg-muted);">
                                    <tr>
                                        <td colspan="2"><strong>Total:</strong></td>
                                        <td style="text-align: right;"><strong>${{ "%.2f"|format(new_total) }}</strong>
                                        </td>
                                    </tr>
                                </tfoot>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Financial Impact -->
                <div class="card-custom"
                    style="border-left: 4px solid {% if diff > 0 %}var(--color-success){% elif diff < 0 %}var(--color-danger){% else %}var(--color-gray-500){% endif %};">
                    <div class="card-header-custom" style="background-color: transparent;">
                        <h6 class="card-title">
                            <i class="bi bi-cash-coin"></i> Impacto Financiero
                        </h6>
                    </div>
                    <div class="card-body-custom">
                        <dl
                            style="display: grid; grid-template-columns: repeat(3, 1fr); gap: var(--spacing-4); margin: 0;">
                            <div>
                                <dt style="font-size: var(--font-size-xs); color: var(--color-text-secondary);">Total
                                    Anterior</dt>
                                <dd>${{ "%.2f"|format(old_total) }}</dd>
                            </div>

                            <div>
                                <dt style="font-size: var(--font-size-xs); color: var(--color-text-secondary);">Total
                                    Nuevo</dt>
                                <dd style="font-weight: bold;">${{ "%.2f"|format(new_total) }}</dd>
                            </div>

                            <div>
                                <dt style="font-size: var(--font-size-xs); color: var(--color-text-secondary);">
                                    Diferencia</dt>
                                <dd>
                                    {% if diff > 0 %}
                                    <span class="badge-custom badge-success">
                                        <i class="bi bi-arrow-up"></i> +${{ "%.2f"|format(diff) }}
                                    </span>
                                    {% elif diff < 0 %} <span class="badge-custom badge-danger">
                                        <i class="bi bi-arrow-down"></i> -${{ "%.2f"|format(diff|abs) }}
                                        </span>
                                        {% else %}
                                        <span class="badge-custom badge-secondary">Sin cambio</span>
                                        {% endif %}
                                </dd>
                            </div>
                        </dl>
                    </div>
                </div>
            </div>

            <!-- Footer -->
            <div class="modal-footer"
                style="padding: var(--spacing-4); border-top: 1px solid var(--color-border-light); background-color: var(--color-bg-muted);">
                <button type="button" class="btn-custom btn-secondary-custom" data-bs-dismiss="modal">
                    <i class="bi bi-x-circle"></i> Cancelar
                </button>

                <!-- Confirm Form -->
                <form method="POST" action="{{ url_for('sales.edit_sale_save', sale_id=sale_id) }}"
                    id="finalEditConfirmForm">
                    {% for line in new_lines %}
                    <input type="hidden" name="lines[{{ loop.index0 }}][product_id]" value="{{ line.product_id }}">
                    <input type="hidden" name="lines[{{ loop.index0 }}][qty]" value="{{ line.qty }}">
                    {% endfor %}

                    <button type="submit" class="btn-custom btn-warning-custom"
                        style="{% if changes.stock_issues %}opacity: 0.5; cursor: not-allowed;{% endif %}" {% if
                        changes.stock_issues %}disabled{% endif %} id="confirmEditBtn">
                        <i class="bi bi-check-circle"></i> Confirmar Corrección
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Auto-open modal script -->
<script>
    (function () {
        const modal = new bootstrap.Modal(document.getElementById('confirmEditSaleModal'));
        modal.show();

        // Clean up modal from DOM when hidden
        document.getElementById('confirmEditSaleModal').addEventListener('hidden.bs.modal', function () {
            document.getElementById('edit-modal-container').innerHTML = '';
        });

        // Disable button on submit to prevent double-click
        document.getElementById('finalEditConfirmForm').addEventListener('submit', function () {
            const btn = document.getElementById('confirmEditBtn');
            btn.disabled = true;
            btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Procesando...';
        });
    })();
</script>