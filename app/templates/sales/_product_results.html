<!-- Product Results Partial (usado por HTMX para bÃºsqueda) -->
{% set display_products = products if products else top_products %}

{% if search_query and not products %}
<div class="empty-search">
    <i class="bi bi-search"></i>
    <p>No se encontraron productos para "{{ search_query }}"</p>

    <a href="{{ url_for('catalog.new_product', name=search_query) }}" class="btn btn-primary mt-3">
        <i class="bi bi-plus-circle"></i> Crear producto "{{ search_query }}"
    </a>
</div>
{% elif display_products %}
<div class="product-grid">
    {% for product in display_products %}
    {% set is_in_cart = false %}
    {% set current_qty = 0 %}
    {% if totals and totals['lines'] %}
    {% for line in totals['lines'] %}
    {% if line.product_id == product.id %}
    {% set is_in_cart = true %}
    {% set current_qty = line.qty %}
    {% endif %}
    {% endfor %}
    {% endif %}

    <div class="product-card {% if is_in_cart %}selected{% endif %}" hx-post="{{ url_for('sales.draft_add') }}"
        hx-trigger="click" hx-target="#cart-container" hx-swap="innerHTML"
        hx-vals='{"product_id": "{{ product.id }}", "qty": 1}' {% if exact_barcode_match==product.id
        %}data-exact-barcode="true" data-product-id="{{ product.id }}" {% endif %}>

        {% if is_in_cart %}
        <div class="selected-badge">{{ current_qty|int }}</div>
        {% endif %}

        <div class="product-image-area">
            {% if product.image_url %}
            <img src="{{ product.image_url }}" alt="{{ product.name }}">
            {% else %}
            <i class="bi bi-box-seam"></i>
            {% endif %}
        </div>

        <div class="product-info">
            <h6 class="product-title" title="{{ product.name }}">{{ product.name }}</h6>
            {% if product.sku %}
            <div class="product-sku">{{ product.sku }}</div>
            {% endif %}

            <div class="product-meta">
                <div class="product-price">${{ product.sale_price|money_ar }}</div>
                <div class="product-stock text-muted">
                    {% if product.on_hand_qty > 0 %}
                    {{ product.on_hand_qty|int }} disp.
                    {% else %}
                    <span class="text-danger">Sin stock</span>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- No hidden form needed with hx-vals -->
    </div>
    {% endfor %}
</div>
{% else %}
<div class="empty-catalog">
    <i class="bi bi-basket"></i>
    <p>No hay productos para mostrar</p>
</div>
{% endif %}

<style>
    .empty-search {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        padding: 4rem 2rem;
        color: #9ca3af;
        text-align: center;
    }

    .empty-search i {
        font-size: 3rem;
        margin-bottom: 1rem;
    }

    .empty-catalog {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        padding: 4rem 2rem;
        color: #9ca3af;
        text-align: center;
    }

    .empty-catalog i {
        font-size: 3rem;
        margin-bottom: 1rem;
    }
</style>