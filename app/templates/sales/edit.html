{% extends "base.html" %}

{% block title %}Editar Venta #{{ sale.id }}{% endblock %}

{% block page_title %}Editando Venta #{{ sale.id }}{% endblock %}

{% block topbar_actions %}
<a href="{{ url_for('sales.detail_sale', sale_id=sale.id) }}" class="btn-custom btn-secondary-custom">
    <i class="bi bi-x-circle"></i> Cancelar
</a>
{% endblock %}

{% block content %}
<!-- Warning Alert -->
<div class="alert-custom alert-warning" style="margin-bottom: var(--spacing-6);">
    <i class="alert-custom-icon bi bi-exclamation-triangle"></i>
    <div class="alert-custom-content">
        <strong>Advertencia:</strong>
        Al guardar los cambios, se generarán automáticamente:
        <ul style="margin: var(--spacing-2) 0 0 0; padding-left: var(--spacing-4);">
            <li>Ajustes de stock (movimientos de tipo ADJUST)</li>
            <li>Asientos contables compensatorios (en el libro mayor)</li>
        </ul>
        <div style="font-size: var(--font-size-xs); color: var(--color-text-secondary); margin-top: var(--spacing-1);">
            Esto mantiene la trazabilidad de la operación original.</div>
    </div>
</div>

<!-- Current Sale Info -->
<div class="card-custom" style="margin-bottom: var(--spacing-6);">
    <div class="card-header-custom" style="background-color: var(--color-bg-muted);">
        <h3 class="card-title" style="font-size: var(--font-size-sm);">
            <i class="bi bi-info-circle"></i> Información Original
        </h3>
    </div>
    <div class="card-body-custom">
        <dl
            style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: var(--spacing-4); margin: 0;">
            <div>
                <dt style="color: var(--color-text-secondary); font-size: var(--font-size-xs);">Fecha</dt>
                <dd style="font-weight: var(--font-weight-medium);">{{ sale.datetime|datetime_ar }}</dd>
            </div>

            <div>
                <dt style="color: var(--color-text-secondary); font-size: var(--font-size-xs);">Total Original</dt>
                <dd style="color: var(--color-primary); font-weight: var(--font-weight-bold);">${{
                    sale.total|money_ar_2 }}</dd>
            </div>
        </dl>
    </div>
</div>

<!-- Edit Form -->
<form method="POST" action="{{ url_for('sales.edit_sale_save', sale_id=sale.id) }}" id="editSaleForm">
    <div class="card-custom" style="margin-bottom: var(--spacing-6);">
        <div class="card-header-custom">
            <h2 class="card-title">
                <i class="bi bi-cart-check"></i> Líneas de Venta (Editar Cantidades)
            </h2>
        </div>
        <div class="table-container">
            <div id="lines-container">
                <table class="table-custom" id="lines-table">
                    <thead>
                        <tr>
                            <th>Producto</th>
                            <th style="text-align: center; width: 150px;">Cantidad</th>
                            <th style="text-align: right;">Precio Unit.</th>
                            <th style="text-align: right;">Stock Disp.</th>
                            <th style="text-align: right;">Subtotal</th>
                            <th style="text-align: center; width: 80px;">Acción</th>
                        </tr>
                    </thead>
                    <tbody id="lines-tbody">
                        {% for line in sale.lines %}
                        <tr class="line-row" data-product-id="{{ line.product_id }}">
                            <td>
                                <strong style="color: var(--color-text-primary);">{{ line.product_name }}</strong>
                                <br><small style="color: var(--color-text-muted);">SKU: {{ line.product_sku or '-' }} |
                                    {{ line.product_uom }}</small>
                                <input type="hidden" name="lines[{{ loop.index0 }}][product_id]"
                                    value="{{ line.product_id }}">
                            </td>
                            <td>
                                <input type="number" class="form-input-custom qty-input"
                                    name="lines[{{ loop.index0 }}][qty]" value="{{ line.qty|int }}" min="1" step="1"
                                    data-unit-price="{{ line.unit_price }}" data-stock="{{ line.current_stock }}"
                                    required style="text-align: center;">
                            </td>
                            <td style="text-align: right;" class="unit-price">${{ line.unit_price|money_ar_2 }}</td>
                            <td style="text-align: right;">
                                <span class="badge-custom badge-info">{{ line.current_stock }}</span>
                            </td>
                            <td style="text-align: right;" class="line-total">
                                <strong>${{ line.line_total|money_ar_2 }}</strong>
                            </td>
                            <td style="text-align: center;">
                                <button type="button" class="btn-custom btn-danger-custom btn-sm" title="Eliminar"
                                    style="display: inline-flex; width: 32px; height: 32px; justify-content: center; align-items: center; padding: 0;">
                                    <i class="bi bi-trash"></i>
                                </button>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                    <tfoot style="background-color: var(--color-bg-muted);">
                        <tr>
                            <td colspan="4"
                                style="text-align: right; font-weight: var(--font-weight-bold); padding: var(--spacing-4);">
                                TOTAL:</td>
                            <td style="text-align: right; padding: var(--spacing-4);">
                                <span
                                    style="font-size: var(--font-size-lg); font-weight: var(--font-weight-bold); color: var(--color-primary);"
                                    id="total-display">
                                    ${{ sale.total|money_ar_2 }}
                                </span>
                            </td>
                            <td></td>
                        </tr>
                    </tfoot>
                </table>
            </div>
        </div>
    </div>

    <!-- Add Product Section -->
    <div class="card-custom" style="margin-bottom: var(--spacing-6);">
        <div class="card-header-custom"
            style="background-color: var(--color-secondary); color: var(--color-text-inverse);">
            <h3 class="card-title" style="color: var(--color-text-inverse);">
                <i class="bi bi-plus-circle"></i> Agregar Producto Nuevo
            </h3>
        </div>
        <div class="card-body-custom">
            <div style="display: grid; grid-template-columns: 2fr 1fr auto; gap: var(--spacing-4); align-items: end;">
                <div class="form-group" style="margin: 0;">
                    <label for="new-product" class="form-label-custom">Producto</label>
                    <select class="form-select-custom" id="new-product">
                        <option value="">Seleccione un producto...</option>
                        {% for product in products %}
                        <option value="{{ product.id }}" data-name="{{ product.name }}"
                            data-sku="{{ product.sku or '-' }}"
                            data-uom="{{ product.uom.symbol if product.uom else '-' }}"
                            data-price="{{ product.sale_price }}" data-stock="{{ product.on_hand_qty }}">
                            {{ product.name }} (Stock: {{ product.on_hand_qty }})
                        </option>
                        {% endfor %}
                    </select>
                </div>
                <div class="form-group" style="margin: 0;">
                    <label for="new-qty" class="form-label-custom">Cantidad</label>
                    <input type="number" class="form-input-custom" id="new-qty" min="1" step="1" placeholder="1">
                </div>
                <div>
                    <button type="button" class="btn-custom btn-primary-custom" id="add-product-btn"
                        style="height: 42px;">
                        <i class="bi bi-plus-circle"></i> Agregar
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Save Button -->
    <div style="display: flex; flex-direction: column; gap: var(--spacing-4);">
        <button type="button" class="btn-custom btn-primary-custom"
            style="justify-content: center; padding: var(--spacing-4); font-size: var(--font-size-lg);"
            hx-post="{{ url_for('sales.edit_sale_preview', sale_id=sale.id) }}" hx-target="#edit-modal-container"
            hx-swap="innerHTML" hx-include="closest form" hx-indicator="#preview-loading">
            <i class="bi bi-check-circle"></i> Guardar Cambios
        </button>
        <div id="preview-loading" class="htmx-indicator"
            style="display: none; justify-content: center; color: var(--color-primary);">
            <div class="spinner-border spinner-border-sm" role="status">
                <span class="visually-hidden">Generando vista previa...</span>
            </div>
        </div>
    </div>
</form>

<!-- Modal Container -->
<div id="edit-modal-container"></div>
{% endblock %}

{% block extra_js %}
<script>
    (function () {
        let lineIndex = {{ sale.lines| length
    }};

    /**
     * Formatea un precio en formato argentino con 2 decimales SIEMPRE:
     * - Separador de miles: punto (.)
     * - Separador decimal: coma (,)
     * - Siempre muestra 2 decimales (ej: 1.500,00)
     */
    function formatPriceAr(value) {
        if (value === null || value === undefined || value === '' || isNaN(value)) return '0,00';

        const num = parseFloat(value);

        // Separar parte entera y decimal (siempre 2 decimales)
        let [integerPart, decimalPart] = num.toFixed(2).split('.');

        // Formatear parte entera con separador de miles
        integerPart = integerPart.replace(/\B(?=(\d{3})+(?!\d))/g, '.');

        // Construir resultado con 2 decimales siempre
        return `${integerPart},${decimalPart}`;
    }

    // Calculate line total
    function calculateLineTotal(qtyInput) {
        const qty = parseFloat(qtyInput.value) || 0;
        const unitPrice = parseFloat(qtyInput.dataset.unitPrice) || 0;
        const lineTotal = qty * unitPrice;

        const row = qtyInput.closest('tr');
        row.querySelector('.line-total').innerHTML = '<strong>$' + formatPriceAr(lineTotal) + '</strong>';

        calculateGrandTotal();
    }

    // Calculate grand total
    function calculateGrandTotal() {
        let total = 0;
        document.querySelectorAll('.line-row').forEach(row => {
            const qtyInput = row.querySelector('.qty-input');
            if (qtyInput) {
                const qty = parseFloat(qtyInput.value) || 0;
                const unitPrice = parseFloat(qtyInput.dataset.unitPrice) || 0;
                total += qty * unitPrice;
            }
        });

        const totalDisplay = document.getElementById('total-display');
        if (totalDisplay) {
            totalDisplay.textContent = '$' + formatPriceAr(total);
        }
    }

    // Qty input change
    document.addEventListener('input', function (e) {
        if (e.target.classList.contains('qty-input')) {
            calculateLineTotal(e.target);
        }
    });

    // Remove line
    document.addEventListener('click', function (e) {
        if (e.target.closest('.remove-line-btn') || (e.target.tagName === 'BUTTON' && e.target.classList.contains('btn-danger-custom'))) {
            // Handle both class 'remove-line-btn' (if I kept it) or just the button
            // In new code above, I didn't add the class 'remove-line-btn' explicitly but I can identify it by context
            // Let's add the class back to be safe or target carefully.
            // Looking at line 81 above: class="btn-custom btn-danger-custom btn-sm" title="Eliminar"
            // I forgot 'remove-line-btn' class. I should fix the JS matching or add class.
            // I'll assume the button is the one with 'btn-danger-custom' inside the table action column.
            const btn = e.target.closest('button');
            if (btn && btn.closest('tr') && btn.classList.contains('btn-danger-custom')) {
                const row = btn.closest('tr');
                row.remove();
                calculateGrandTotal();
                reindexLines();
            }
        }
    });

    // Reindex form field names after removing lines
    function reindexLines() {
        const rows = document.querySelectorAll('.line-row');
        rows.forEach((row, index) => {
            row.querySelectorAll('input[name^="lines["]').forEach(input => {
                const fieldName = input.name.match(/\[([^\]]+)\]$/)[1];
                input.name = `lines[${index}][${fieldName}]`;
            });
        });
        lineIndex = rows.length;
    }

    // Add product
    document.getElementById('add-product-btn').addEventListener('click', function () {
        const select = document.getElementById('new-product');
        const qtyInput = document.getElementById('new-qty');

        if (!select.value || !qtyInput.value) {
            alert('Seleccione un producto e ingrese cantidad');
            return;
        }

        const option = select.options[select.selectedIndex];
        const productId = option.value;
        const productName = option.dataset.name;
        const productSku = option.dataset.sku;
        const productUom = option.dataset.uom;
        const unitPrice = parseFloat(option.dataset.price);
        const stock = parseFloat(option.dataset.stock);
        const qty = parseFloat(qtyInput.value);

        // Check if product already exists
        const existingRow = document.querySelector(`.line-row[data-product-id="${productId}"]`);
        if (existingRow) {
            alert('Este producto ya está en la lista. Modifique la cantidad en la tabla.');
            return;
        }

        // Check stock
        if (qty > stock) {
            alert(`Stock insuficiente. Disponible: ${stock}`);
            return;
        }

        const lineTotal = qty * unitPrice;

        // Create new row
        const tbody = document.getElementById('lines-tbody');
        const newRow = document.createElement('tr');
        newRow.className = 'line-row';
        newRow.dataset.productId = productId;
        newRow.innerHTML = `
            <td>
                <strong style="color: var(--color-text-primary);">${productName}</strong>
                <br><small style="color: var(--color-text-muted);">SKU: ${productSku} | ${productUom}</small>
                <input type="hidden" name="lines[${lineIndex}][product_id]" value="${productId}">
            </td>
            <td>
                <input type="number" 
                       class="form-input-custom qty-input" 
                       name="lines[${lineIndex}][qty]" 
                       value="${Math.floor(qty)}"
                       min="1"
                       step="1"
                       data-unit-price="${unitPrice}"
                       data-stock="${stock}"
                       required
                       style="text-align: center;">
            </td>
            <td style="text-align: right;" class="unit-price">$${formatPriceAr(unitPrice)}</td>
            <td style="text-align: right;">
                <span class="badge-custom badge-info">${stock}</span>
            </td>
            <td style="text-align: right;" class="line-total">
                <strong>$${formatPriceAr(lineTotal)}</strong>
            </td>
            <td style="text-align: center;">
                <button type="button" class="btn-custom btn-danger-custom btn-sm" title="Eliminar" style="display: inline-flex; width: 32px; height: 32px; justify-content: center; align-items: center; padding: 0;">
                    <i class="bi bi-trash"></i>
                </button>
            </td>
        `;

        tbody.appendChild(newRow);
        lineIndex++;

        // Reset inputs
        select.value = '';
        qtyInput.value = '';

        calculateGrandTotal();
    });
}) ();
</script>
{% endblock %}