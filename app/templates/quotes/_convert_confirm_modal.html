<div class="modal fade" id="confirmConvertQuoteModal" tabindex="-1" aria-labelledby="confirmConvertQuoteModalLabel" aria-hidden="true" data-bs-backdrop="static">
    <div class="modal-dialog modal-lg modal-dialog-centered modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title" id="confirmConvertQuoteModalLabel">
                    <i class="bi bi-check-circle"></i> Confirmar Conversión a Venta
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-info small" role="alert">
                    <i class="bi bi-info-circle"></i> Revise los detalles antes de confirmar. Esta acción convertirá el presupuesto <strong>{{ quote.quote_number }}</strong> en una venta confirmada.
                </div>

                <!-- Quote Summary -->
                <div class="card mb-3">
                    <div class="card-header bg-light">
                        <h6 class="mb-0"><i class="bi bi-file-earmark-text"></i> Información del Presupuesto</h6>
                    </div>
                    <div class="card-body">
                        <dl class="row mb-0">
                            <dt class="col-sm-4">Número:</dt>
                            <dd class="col-sm-8"><strong>{{ quote.quote_number }}</strong></dd>
                            
                            <dt class="col-sm-4">Cliente:</dt>
                            <dd class="col-sm-8">
                                <strong>{{ quote.customer_name }}</strong>
                                {% if quote.customer_phone %}
                                <br><small class="text-muted">
                                    <i class="bi bi-telephone"></i> {{ quote.customer_phone }}
                                </small>
                                {% endif %}
                            </dd>
                            
                            <dt class="col-sm-4">Fecha Emisión:</dt>
                            <dd class="col-sm-8">{{ quote.issued_at|datetime_ar }}</dd>
                            
                            {% if quote.payment_method %}
                            <dt class="col-sm-4">Método de Pago:</dt>
                            <dd class="col-sm-8">
                                {% if quote.payment_method == 'CASH' %}
                                <i class="bi bi-cash"></i> Efectivo
                                {% else %}
                                <i class="bi bi-bank"></i> Transferencia
                                {% endif %}
                            </dd>
                            {% endif %}
                            
                            <dt class="col-sm-4">Total:</dt>
                            <dd class="col-sm-8">
                                <h5 class="mb-0 text-success">${{ quote.total_amount|money_ar }}</h5>
                            </dd>
                        </dl>
                    </div>
                </div>

                <!-- Items Detail -->
                <div class="card mb-3">
                    <div class="card-header bg-light">
                        <h6 class="mb-0"><i class="bi bi-list-ul"></i> Detalle de Productos ({{ quote.lines|length }})</h6>
                    </div>
                    <div class="card-body p-0">
                        <div class="table-responsive">
                            <table class="table table-sm table-hover mb-0">
                                <thead class="table-light">
                                    <tr>
                                        <th>Producto</th>
                                        <th class="text-center">Cantidad</th>
                                        <th class="text-end">Precio Unit.</th>
                                        <th class="text-center">Stock Actual</th>
                                        <th class="text-end">Subtotal</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for line in quote.lines %}
                                    <tr>
                                        <td>
                                            <strong>{{ line.product.name }}</strong>
                                            <br>
                                            <small class="text-muted">SKU: {{ line.product.sku or '-' }}</small>
                                        </td>
                                        <td class="text-center">{{ line.qty|num_ar }}</td>
                                        <td class="text-end">${{ line.unit_price|money_ar }}</td>
                                        <td class="text-center">
                                            {% if line.product.on_hand_qty >= line.qty %}
                                            <span class="badge bg-success">{{ line.product.on_hand_qty|num_ar }}</span>
                                            {% elif line.product.on_hand_qty > 0 %}
                                            <span class="badge bg-warning text-dark">{{ line.product.on_hand_qty|num_ar }}</span>
                                            {% else %}
                                            <span class="badge bg-danger">0</span>
                                            {% endif %}
                                        </td>
                                        <td class="text-end"><strong>${{ line.line_total|money_ar }}</strong></td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                                <tfoot class="table-light">
                                    <tr>
                                        <td colspan="4" class="text-end"><strong>TOTAL:</strong></td>
                                        <td class="text-end">
                                            <h5 class="mb-0 text-success">${{ quote.total_amount|money_ar }}</h5>
                                        </td>
                                    </tr>
                                </tfoot>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Stock Warning -->
                {% if stock_warnings %}
                <div class="alert alert-danger" role="alert">
                    <i class="bi bi-exclamation-triangle-fill"></i>
                    <strong>Advertencia de Stock:</strong>
                    <ul class="mb-0 mt-2">
                        {% for warning in stock_warnings %}
                        <li>{{ warning }}</li>
                        {% endfor %}
                    </ul>
                    <p class="mb-0 mt-2">
                        <strong>No se puede convertir este presupuesto a venta debido a stock insuficiente.</strong>
                    </p>
                </div>
                {% else %}
                <!-- Success Info -->
                <div class="alert alert-success" role="alert">
                    <i class="bi bi-check-circle-fill"></i>
                    <strong>Conversión Lista:</strong>
                    <ul class="mb-0 mt-2">
                        <li>Se creará una nueva venta con estos productos</li>
                        <li>Se descontará automáticamente el stock</li>
                        <li>Se registrará un <strong>INGRESO</strong> de <strong>${{ quote.total_amount|money_ar }}</strong> en el libro mayor</li>
                        <li>El presupuesto quedará marcado como <strong>ACEPTADO</strong></li>
                    </ul>
                </div>
                {% endif %}

            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="bi bi-x-circle"></i> Cancelar
                </button>
                
                {% if not stock_warnings %}
                <form method="POST" action="{{ url_for('quotes.convert_to_sale', quote_id=quote.id) }}" id="confirmConvertForm">
                    <button type="submit" 
                            class="btn btn-success"
                            id="confirmConvertBtn">
                        <i class="bi bi-check-circle"></i> Confirmar Conversión
                    </button>
                </form>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<script>
// Auto-open the modal when it's inserted into the DOM
(function() {
    const modalElement = document.getElementById('confirmConvertQuoteModal');
    if (modalElement) {
        const modal = new bootstrap.Modal(modalElement);
        modal.show();
        
        // Disable button on submit to prevent double-click
        const form = document.getElementById('confirmConvertForm');
        const btn = document.getElementById('confirmConvertBtn');
        if (form && btn) {
            form.addEventListener('submit', function() {
                btn.disabled = true;
                btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span> Procesando...';
            });
        }
        
        // Optional: Remove modal from DOM after it's hidden
        modalElement.addEventListener('hidden.bs.modal', function () {
            modalElement.remove();
        });
    }
})();
</script>
