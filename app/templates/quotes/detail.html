{% extends "base.html" %}

{% block title %}Presupuesto {{ quote.quote_number }}{% endblock %}

{% block page_title %}Presupuesto {{ quote.quote_number }}{% endblock %}

{% block topbar_actions %}
<a href="{{ url_for('quotes.list_quotes') }}" class="btn-custom btn-secondary-custom">
    <i class="bi bi-arrow-left"></i> Volver al Listado
</a>
{% endblock %}

{% block content %}
<div style="display: grid; grid-template-columns: 2fr 1fr; gap: var(--spacing-6);">
    <!-- Left Column: Info & Lines -->
    <div>
        <!-- Quote Info -->
        <div class="card-custom" style="margin-bottom: var(--spacing-6);">
            <div class="card-header-custom"
                style="background-color: var(--color-primary); color: var(--color-text-inverse);">
                <h2 class="card-title" style="color: var(--color-text-inverse); margin: 0;">Información del Presupuesto
                </h2>
            </div>
            <div class="card-body-custom">
                <dl
                    style="display: grid; grid-template-columns: auto 1fr; gap: var(--spacing-4) var(--spacing-8); margin: 0;">
                    <dt style="color: var(--color-text-secondary);">Número:</dt>
                    <dd style="font-weight: var(--font-weight-semibold);">{{ quote.quote_number }}</dd>

                    <dt style="color: var(--color-text-secondary);">Estado:</dt>
                    <dd>
                        {% if quote.status == 'DRAFT' %}
                        <span class="badge-custom badge-secondary">Borrador</span>
                        {% elif quote.status == 'SENT' %}
                        <span class="badge-custom badge-info">Enviado</span>
                        {% elif quote.status == 'ACCEPTED' %}
                        <span class="badge-custom badge-success">Aceptado</span>
                        {% elif quote.status == 'CANCELED' %}
                        <span class="badge-custom badge-danger">Cancelado</span>
                        {% endif %}

                        {% if quote.is_expired %}
                        <span class="badge-custom badge-warning" style="margin-left: var(--spacing-1);">
                            <i class="bi bi-exclamation-triangle"></i> Vencido
                        </span>
                        {% endif %}
                    </dd>

                    <dt style="color: var(--color-text-secondary);">Fecha Emisión:</dt>
                    <dd>{{ quote.issued_at|datetime_ar }}</dd>

                    <dt style="color: var(--color-text-secondary);">Válido Hasta:</dt>
                    <dd>
                        {% if quote.valid_until %}
                        {{ quote.valid_until|date_ar }}
                        {% else %}
                        -
                        {% endif %}
                    </dd>

                    <dt style="color: var(--color-text-secondary);">Cliente:</dt>
                    <dd>
                        <strong style="color: var(--color-text-primary);">{{ quote.customer_name }}</strong>
                        {% if quote.customer_phone %}
                        <br><small style="color: var(--color-text-muted);">
                            <i class="bi bi-telephone"></i> {{ quote.customer_phone }}
                        </small>
                        {% endif %}
                    </dd>

                    {% if quote.payment_method %}
                    <dt style="color: var(--color-text-secondary);">Método de Pago:</dt>
                    <dd>
                        {% if quote.payment_method == 'CASH' %}
                        <i class="bi bi-cash"></i> Efectivo
                        {% else %}
                        <i class="bi bi-bank"></i> Transferencia
                        {% endif %}
                    </dd>
                    {% endif %}

                    {% if quote.sale_id %}
                    <dt style="color: var(--color-text-secondary);">Venta Asociada:</dt>
                    <dd>
                        <strong style="color: var(--color-primary);">Venta #{{ quote.sale_id }}</strong>
                    </dd>
                    {% endif %}
                </dl>

                {% if quote.notes %}
                <div
                    style="margin-top: var(--spacing-4); padding-top: var(--spacing-4); border-top: 1px solid var(--color-border-light);">
                    <p style="margin: 0;">
                        <strong style="color: var(--color-text-secondary);">Notas:</strong><br>
                        {{ quote.notes }}
                    </p>
                </div>
                {% endif %}
            </div>
        </div>

        <!-- Quote Lines -->
        <div class="card-custom">
            <div class="card-header-custom">
                <h2 class="card-title">
                    <i class="bi bi-list-ul"></i> Detalle de Productos
                </h2>
            </div>
            <div class="table-container" style="border: none;">
                <table class="table-custom">
                    <thead>
                        <tr>
                            <th>Producto</th>
                            <th style="text-align: center;">UOM</th>
                            <th style="text-align: center;">Cantidad</th>
                            <th style="text-align: right;">Precio Unitario</th>
                            <th style="text-align: right;">Subtotal</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for line in quote.lines %}
                        <tr>
                            <td>
                                <strong style="color: var(--color-text-primary);">{{ line.product_name_snapshot
                                    }}</strong>
                                <br><small style="color: var(--color-text-muted);">Producto ID: {{ line.product_id
                                    }}</small>
                            </td>
                            <td style="text-align: center;">
                                {% if line.uom_snapshot %}
                                <span class="badge-custom badge-info">{{ line.uom_snapshot }}</span>
                                {% else %}
                                -
                                {% endif %}
                            </td>
                            <td style="text-align: center;">
                                {% if line.qty % 1 == 0 %}
                                {{ line.qty|int }}
                                {% else %}
                                {{ "%.2f"|format(line.qty) }}
                                {% endif %}
                            </td>
                            <td style="text-align: right;">${{ "%.2f"|format(line.unit_price) }}</td>
                            <td style="text-align: right;"><strong style="color: var(--color-text-primary);">${{
                                    "%.2f"|format(line.line_total) }}</strong></td>
                        </tr>
                        {% endfor %}
                    </tbody>
                    <tfoot style="background-color: var(--color-bg-muted); font-weight: var(--font-weight-bold);">
                        <tr>
                            <td colspan="4" style="text-align: right; padding: var(--spacing-4);">TOTAL:</td>
                            <td style="text-align: right; padding: var(--spacing-4);">
                                <span style="font-size: var(--font-size-xl); color: var(--color-success);">${{
                                    "%.2f"|format(quote.total_amount) }}</span>
                            </td>
                        </tr>
                    </tfoot>
                </table>
            </div>
        </div>

        <!-- Info messages -->
        {% if quote.is_expired %}
        <div class="alert-custom alert-warning" style="margin-top: var(--spacing-4);">
            <i class="alert-custom-icon bi bi-exclamation-triangle-fill"></i>
            <div class="alert-custom-content">
                <strong>Presupuesto Vencido:</strong>
                Este presupuesto expiró el {{ quote.valid_until|date_ar }}. No se puede convertir a venta.
            </div>
        </div>
        {% endif %}

        {% if quote.status == 'ACCEPTED' and quote.sale_id %}
        <div class="alert-custom alert-success" style="margin-top: var(--spacing-4);">
            <i class="alert-custom-icon bi bi-check-circle-fill"></i>
            <div class="alert-custom-content">
                <strong>Presupuesto Aceptado:</strong>
                Este presupuesto fue convertido a la <strong>Venta #{{ quote.sale_id }}</strong>.
            </div>
        </div>
        {% endif %}

        {% if quote.status == 'CANCELED' %}
        <div class="alert-custom alert-danger" style="margin-top: var(--spacing-4);">
            <i class="alert-custom-icon bi bi-x-circle-fill"></i>
            <div class="alert-custom-content">
                <strong>Presupuesto Cancelado:</strong>
                Este presupuesto ha sido cancelado y no puede ser convertido a venta.
            </div>
        </div>
        {% endif %}
    </div>

    <!-- Right Column: Actions -->
    <div>
        <div class="card-custom">
            <div class="card-header-custom"
                style="background-color: var(--color-success); color: var(--color-text-inverse);">
                <h2 class="card-title" style="color: var(--color-text-inverse); margin: 0;">Total</h2>
            </div>
            <div class="card-body-custom" style="text-align: center; padding: var(--spacing-8) var(--spacing-4);">
                <h1 style="font-size: var(--font-size-4xl); color: var(--color-success); margin: 0;">${{
                    quote.total_amount|money_ar }}</h1>
            </div>
        </div>

        <div class="card-custom">
            <div class="card-header-custom">
                <h2 class="card-title">Acciones</h2>
            </div>
            <div class="card-body-custom">
                <div style="display: flex; flex-direction: column; gap: var(--spacing-3);">
                    <!-- Download PDF -->
                    <a href="{{ url_for('quotes.download_pdf', quote_id=quote.id) }}"
                        class="btn-custom btn-secondary-custom" target="_blank" style="justify-content: center;">
                        <i class="bi bi-file-earmark-pdf"></i> Descargar PDF
                    </a>

                    <!-- Edit Quote -->
                    {% if quote.status in ['DRAFT', 'SENT'] and not quote.is_expired %}
                    <a href="{{ url_for('quotes.edit_quote', quote_id=quote.id) }}"
                        class="btn-custom btn-primary-custom" style="justify-content: center;">
                        <i class="bi bi-pencil"></i> Editar Presupuesto
                    </a>
                    {% endif %}

                    <!-- Convert to Sale -->
                    {% if quote.is_convertible %}
                    <button type="button" class="btn-custom btn-success-custom"
                        hx-get="{{ url_for('quotes.convert_to_sale_preview', quote_id=quote.id) }}"
                        hx-target="#modal-container" hx-swap="innerHTML" style="justify-content: center;">
                        <i class="bi bi-check-circle"></i> Convertir a Venta
                    </button>
                    {% endif %}

                    <!-- Mark as Sent -->
                    {% if quote.status == 'DRAFT' %}
                    <form method="POST" action="{{ url_for('quotes.mark_as_sent', quote_id=quote.id) }}"
                        style="margin: 0;">
                        <button type="submit" class="btn-custom btn-secondary-custom"
                            style="width: 100%; justify-content: center; border-color: var(--color-info); color: var(--color-info);">
                            <i class="bi bi-send"></i> Marcar como Enviado
                        </button>
                    </form>
                    {% endif %}

                    <!-- Cancel -->
                    {% if quote.status in ['DRAFT', 'SENT'] %}
                    <form method="POST" action="{{ url_for('quotes.cancel_quote', quote_id=quote.id) }}"
                        onsubmit="return confirm('¿Cancelar este presupuesto?\n\nNo se podrá revertir esta acción.');"
                        style="margin: 0;">
                        <button type="submit" class="btn-custom btn-danger-custom"
                            style="width: 100%; justify-content: center;">
                            <i class="bi bi-x-circle"></i> Cancelar Presupuesto
                        </button>
                    </form>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal Container for HTMX -->
<div id="modal-container"></div>
{% endblock %}

{% block extra_css %}
<style>
    @media (max-width: 1023px) {
        .app-content>div {
            grid-template-columns: 1fr !important;
        }
    }
</style>
{% endblock %}