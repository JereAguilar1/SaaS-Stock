{% extends "base.html" %}

{% block title %}
{% if action == 'new' %}Nuevo Producto{% else %}Editar Producto{% endif %} - Sistema Ferretería
{% endblock %}

{% block page_title %}{% if action == 'new' %}Nuevo Producto{% else %}Editar Producto{% endif %}{% endblock %}

{% block topbar_actions %}
<a href="{{ url_for('catalog.list_products') }}" class="btn-custom btn-secondary-custom">
    <i class="bi bi-arrow-left"></i> Volver
</a>
{% endblock %}

{% block extra_css %}
<!-- Cropper.js CSS -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.6.1/cropper.min.css">
<style>
    /* Ocultar spinners (flechas) en inputs de precio */
    .no-spinner::-webkit-outer-spin-button,
    .no-spinner::-webkit-inner-spin-button {
        -webkit-appearance: none;
        margin: 0;
    }

    .no-spinner[type=number] {
        -moz-appearance: textfield;
    }

    /* Image preview styles */
    .image-preview-container {
        margin-top: var(--spacing-3);
        border: 2px dashed var(--color-border-medium);
        border-radius: var(--radius-md);
        padding: var(--spacing-4);
        text-align: center;
        background-color: var(--color-bg-muted);
    }

    .image-preview-container img {
        max-width: 200px;
        max-height: 200px;
        border-radius: var(--radius-md);
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }

    .image-preview-container.has-image {
        border-color: var(--color-success);
        background-color: var(--color-success-light);
    }
</style>
{% endblock %}

{% block content %}
<!-- Alert if no UOMs available -->
{% if not uoms or uoms|length == 0 %}
<div class="alert-custom alert-warning" style="margin-bottom: var(--spacing-6);">
    <i class="alert-custom-icon bi bi-exclamation-triangle"></i>
    <div class="alert-custom-content">
        <strong>No hay unidades de medida registradas.</strong>
        <p style="margin: var(--spacing-1) 0 0 0;">Debe crear al menos una unidad de medida antes de poder crear
            productos.</p>
        <a href="{{ url_for('settings.list_uoms') }}"
            style="color: inherit; font-weight: var(--font-weight-bold); margin-top: var(--spacing-2); display: inline-block;">
            <i class="bi bi-plus-circle"></i> Ir a Unidades de Medida
        </a>
    </div>
</div>
{% endif %}

<div style="display: grid; grid-template-columns: 1fr 340px; gap: var(--spacing-6);">
    <div>
        <div class="card-custom">
            <div class="card-header-custom">
                <h2 class="card-title">
                    {{ 'Crear Nuevo Producto' if action == 'new' else 'Editar Producto' }}
                </h2>
            </div>
            <div class="card-body-custom">
                <form method="POST"
                    action="{% if action == 'new' %}{{ url_for('catalog.create_product') }}{% else %}{{ url_for('catalog.update_product', product_id=product.id) }}{% endif %}"
                    enctype="multipart/form-data">

                    <!-- Name -->
                    <div class="form-group">
                        <label for="name" class="form-label-custom">
                            Nombre <span style="color: var(--color-danger);">*</span>
                        </label>
                        <input type="text" class="form-input-custom" id="name" name="name"
                            value="{{ product.name if product else (request.args.get('name', '') if action == 'new' else '') }}"
                            required maxlength="255" placeholder="Ej: Martillo Galponero 25mm" autocomplete="off"
                            style="font-size: var(--font-size-lg); font-weight: var(--font-weight-medium);">
                    </div>

                    <!-- SKU and Barcode -->
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: var(--spacing-4);">
                        <div class="form-group">
                            <label for="sku" class="form-label-custom">SKU</label>
                            <input type="text" class="form-input-custom" id="sku" name="sku"
                                value="{{ product.sku or '' if product else '' }}" maxlength="100"
                                placeholder="Código interno" autocomplete="off"
                                hx-post="{{ url_for('catalog.check_sku') }}" hx-trigger="keyup changed delay:500ms"
                                hx-target="#sku-error-container" hx-swap="outerHTML" hx-include="[name='product_id']">
                            <input type="hidden" name="product_id" value="{{ product.id or '' if product else '' }}">
                            <div id="sku-error-container"></div>
                        </div>
                        <div class="form-group">
                            <label for="barcode" class="form-label-custom">Código de Barras</label>
                            <input type="text" class="form-input-custom" id="barcode" name="barcode"
                                value="{{ product.barcode or '' if product else '' }}" maxlength="100"
                                placeholder="EAN-13 / UPC" autocomplete="off">
                        </div>
                    </div>

                    <!-- Category and UOM -->
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: var(--spacing-4);">
                        <div class="form-group">
                            <label for="category_id" class="form-label-custom">Categoría</label>
                            <select class="form-select-custom" id="category_id" name="category_id">
                                <option value="">Sin categoría</option>
                                {% for category in categories %}
                                <option value="{{ category.id }}" {% if product and product.category_id==category.id
                                    %}selected{% endif %}>
                                    {{ category.name }}
                                </option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="uom_id" class="form-label-custom">
                                Unidad de Medida <span style="color: var(--color-danger);">*</span>
                            </label>
                            <select class="form-select-custom" id="uom_id" name="uom_id" required {% if not uoms or
                                uoms|length==0 %}disabled{% endif %}>
                                <option value="">{% if uoms and uoms|length > 0 %}Seleccione una unidad{% else %}Sin
                                    unidades disponibles{% endif %}</option>
                                {% for uom in uoms %}
                                <option value="{{ uom.id }}" {% if product and product.uom_id==uom.id %}selected{% endif
                                    %}>
                                    {{ uom.name }} ({{ uom.symbol }})
                                </option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>

                    <hr style="border-color: var(--color-border-light); margin: var(--spacing-6) 0;">

                    <!-- Unified Pricing & Stock Grid -->
                    <div
                        style="display: grid; grid-template-columns: 1fr 1fr; gap: var(--spacing-4); align-items: start;">
                        <!-- 1. Cost -->
                        <div class="form-group">
                            <label for="cost" class="form-label-custom">
                                Costo (Precio de Compra)
                            </label>
                            <div style="position: relative;">
                                <span
                                    style="position: absolute; left: 12px; top: 50%; transform: translateY(-50%); color: var(--color-text-muted);">$</span>
                                <input type="text" class="form-input-custom no-spinner" id="cost" name="cost"
                                    value="{% if product and product.cost %}{{ '{:,.2f}'.format(product.cost).replace(',', 'X').replace('.', ',').replace('X', '.') }}{% else %}0,00{% endif %}"
                                    inputmode="decimal" autocomplete="off"
                                    onfocus="if(this.value === '0,00' || this.value === '0') this.value = '';"
                                    onblur="if(this.value === '') this.value = '0,00';"
                                    style="padding-left: 28px; color: var(--color-text-secondary);"
                                    placeholder="1.000,00">
                            </div>
                        </div>

                        <!-- 2. Sale Price -->
                        <div class="form-group">
                            <label for="sale_price" class="form-label-custom">
                                Precio de Venta <span style="color: var(--color-danger);">*</span>
                            </label>
                            <div style="position: relative;">
                                <span
                                    style="position: absolute; left: 12px; top: 50%; transform: translateY(-50%); color: var(--color-text-muted);">$</span>
                                <input type="text" class="form-input-custom no-spinner" id="sale_price"
                                    name="sale_price"
                                    value="{% if product and product.sale_price %}{{ '{:,.2f}'.format(product.sale_price).replace(',', 'X').replace('.', ',').replace('X', '.') }}{% else %}0,00{% endif %}"
                                    inputmode="decimal" required autocomplete="off"
                                    onfocus="if(this.value === '0,00' || this.value === '0') this.value = '';"
                                    onblur="if(this.value === '') this.value = '0,00';"
                                    style="padding-left: 28px; font-weight: var(--font-weight-bold); color: var(--color-success);"
                                    placeholder="1.000,00">
                            </div>
                        </div>

                        <!-- 3. Min Stock -->
                        <div class="form-group">
                            <label for="min_stock_qty" class="form-label-custom">
                                Stock Mínimo
                            </label>
                            <input type="number" class="form-input-custom" id="min_stock_qty" name="min_stock_qty"
                                value="{{ product.min_stock_qty | int if product and product.min_stock_qty is not none else '' }}"
                                step="1" min="0" autocomplete="off" placeholder="0"
                                oninput="if(this.value < 0) this.value = 0; this.value = Math.floor(this.value);"
                                style="font-family: monospace;">
                        </div>

                        <!-- 4. Initial Stock (Only New) -->
                        {% if action == 'new' %}
                        <div class="form-group">
                            <label for="initial_stock" class="form-label-custom">
                                Stock Actual (Inicial)
                            </label>
                            <input type="number" class="form-input-custom" id="initial_stock" name="initial_stock"
                                value="{{ product.initial_stock or '' if product and product.initial_stock is not none else '' }}"
                                step="1" min="0" autocomplete="off" placeholder="0"
                                oninput="if(this.value < 0) this.value = 0; this.value = Math.floor(this.value);"
                                style="font-family: monospace;">
                        </div>
                        {% endif %}
                    </div>

                    <div class="form-group">
                        <label class="form-label-custom">Estado</label>
                        <div style="display: flex; align-items: center; gap: var(--spacing-2);">
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" id="active" name="active" {% if not
                                    product or product.active %}checked{% endif %}>
                                <label class="form-check-label" for="active" style="cursor: pointer;">
                                    Producto activo (visible en ventas)
                                </label>
                            </div>
                        </div>
                    </div>

                    <hr style="border-color: var(--color-border-light); margin: var(--spacing-6) 0;">

                    <!-- Product Image -->
                    <div class="form-group">
                        <label for="image" class="form-label-custom">Imagen del Producto</label>

                        <!-- Current Image Preview -->
                        {% if product and product.image_path %}
                        <div style="margin-bottom: var(--spacing-4);">
                            <div
                                style="border: 1px solid var(--color-border-medium); padding: var(--spacing-2); display: inline-block; border-radius: var(--radius-md); background-color: white;">
                                <img src="{{ product.image_path }}" alt="{{ product.name }}"
                                    style="max-width: 150px; height: auto; display: block;">
                            </div>
                            <p
                                style="margin: var(--spacing-1) 0 0 0; font-size: var(--font-size-xs); color: var(--color-text-muted);">
                                Imagen actual</p>
                        </div>
                        {% endif %}

                        <!-- Hidden file input -->
                        <input type="file" class="form-input-custom" id="image" name="image"
                            accept="image/jpeg,image/jpg,image/png" style="display: none;">

                        <!-- Custom button to trigger file selection -->
                        <button type="button" class="btn-custom btn-secondary-custom" id="selectImageBtn">
                            <i class="bi bi-image"></i> Seleccionar Imagen
                        </button>

                        <!-- Image preview container -->
                        <div id="imagePreviewContainer" class="image-preview-container" style="display: none;">
                            <img id="imagePreview" alt="Vista previa">
                            <p
                                style="margin-top: var(--spacing-2); font-size: var(--font-size-sm); color: var(--color-text-secondary);">
                                <i class="bi bi-check-circle"></i> Imagen lista para subir
                            </p>
                            <button type="button" class="btn-custom btn-ghost-custom btn-sm" id="changeImageBtn"
                                style="margin-top: var(--spacing-2);">
                                <i class="bi bi-arrow-repeat"></i> Cambiar imagen
                            </button>
                        </div>

                        <small
                            style="color: var(--color-text-muted); font-size: var(--font-size-xs); margin-top: var(--spacing-1); display: block;">
                            Formatos permitidos: JPG, JPEG, PNG. Tamaño máximo: 2MB.
                            {% if product and product.image_path %}
                            Subir una imagen reemplazará la actual.
                            {% endif %}
                        </small>
                    </div>

                    {% if product %}
                    <!-- Stock Info (read-only) -->
                    <div class="alert-custom alert-info" style="margin-top: var(--spacing-6);">
                        <i class="alert-custom-icon bi bi-info-circle"></i>
                        <div class="alert-custom-content">
                            <strong>Stock actual:</strong>
                            {{ "%.2f"|format(product.on_hand_qty) }} {{ product.uom.symbol }}
                        </div>
                    </div>
                    {% endif %}

                    <!-- Actions -->
                    <div
                        style="display: flex; justify-content: flex-end; gap: var(--spacing-2); margin-top: var(--spacing-6);">
                        <a href="{{ url_for('catalog.list_products') }}" class="btn-custom btn-secondary-custom">
                            <i class="bi bi-x-circle"></i> Cancelar
                        </a>
                        <button type="submit" class="btn-custom btn-primary-custom" {% if not uoms or uoms|length==0
                            %}disabled style="opacity: 0.5; cursor: not-allowed;" {% endif %}>
                            <i class="bi bi-save"></i>
                            {% if action == 'new' %}Crear Producto{% else %}Guardar Cambios{% endif %}
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Help Card -->
    <div>
        <div class="card-custom" style="background-color: var(--color-bg-muted);">
            <div class="card-header-custom">
                <h2 class="card-title" style="font-size: var(--font-size-sm);">
                    <i class="bi bi-question-circle"></i> Ayuda
                </h2>
            </div>
            <div class="card-body-custom">
                <h6 style="margin-bottom: var(--spacing-2); font-weight: var(--font-weight-semibold);">Campos
                    requeridos:</h6>
                <ul
                    style="font-size: var(--font-size-sm); color: var(--color-text-secondary); padding-left: var(--spacing-4); margin-bottom: var(--spacing-4);">
                    <li><strong>Nombre:</strong> Identificación del producto</li>
                    <li><strong>Unidad de Medida:</strong> Cómo se mide (UN, KG, M, etc.)</li>
                    <li><strong>Precio de Venta:</strong> Precio al público</li>
                </ul>

                <h6 style="margin-bottom: var(--spacing-2); font-weight: var(--font-weight-semibold);">Campos
                    opcionales:</h6>
                <ul
                    style="font-size: var(--font-size-sm); color: var(--color-text-secondary); padding-left: var(--spacing-4); margin: 0;">
                    <li><strong>SKU:</strong> Código interno único</li>
                    <li><strong>Código de Barras:</strong> Para escaneo</li>
                    <li><strong>Categoría:</strong> Para organizar productos</li>
                </ul>

                <hr style="border-color: var(--color-border-light); margin: var(--spacing-4) 0;">

                <div class="alert-custom alert-warning" style="margin: 0; padding: var(--spacing-3);">
                    <i class="alert-custom-icon bi bi-exclamation-triangle" style="font-size: var(--font-size-md);"></i>
                    <div class="alert-custom-content" style="font-size: var(--font-size-xs);">
                        El SKU y código de barras deben ser únicos si se proporcionan.
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Cropper Modal -->
<div class="modal fade" id="cropperModal" tabindex="-1" aria-labelledby="cropperModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="cropperModalLabel">
                    <i class="bi bi-crop"></i> Ajustar Imagen del Producto
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div style="max-height: 500px; overflow: hidden;">
                    <img id="cropperImage" style="max-width: 100%; display: block;">
                </div>
                <div
                    style="margin-top: var(--spacing-4); padding: var(--spacing-3); background-color: var(--color-bg-muted); border-radius: var(--radius-md);">
                    <p style="margin: 0; font-size: var(--font-size-sm); color: var(--color-text-secondary);">
                        <i class="bi bi-info-circle"></i> Arrastra para posicionar y usa la rueda del mouse para hacer
                        zoom. La imagen se recortará en formato cuadrado.
                    </p>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn-custom btn-secondary-custom" data-bs-dismiss="modal">
                    <i class="bi bi-x-circle"></i> Cancelar
                </button>
                <button type="button" class="btn-custom btn-primary-custom" id="applyCrop">
                    <i class="bi bi-check-circle"></i> Aplicar Recorte
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<!-- Cropper.js -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.6.1/cropper.min.js"></script>

<script>
    // Image Cropper Logic
    let cropper = null;
    let croppedBlob = null;

    const imageInput = document.getElementById('image');
    const selectImageBtn = document.getElementById('selectImageBtn');
    const changeImageBtn = document.getElementById('changeImageBtn');
    const cropperModal = new bootstrap.Modal(document.getElementById('cropperModal'));
    const cropperImage = document.getElementById('cropperImage');
    const applyCropBtn = document.getElementById('applyCrop');
    const imagePreviewContainer = document.getElementById('imagePreviewContainer');
    const imagePreview = document.getElementById('imagePreview');

    // Trigger file input when button is clicked
    selectImageBtn.addEventListener('click', () => {
        imageInput.click();
    });

    changeImageBtn.addEventListener('click', () => {
        imageInput.click();
    });

    // Handle file selection
    imageInput.addEventListener('change', function (e) {
        const file = e.target.files[0];

        if (!file) return;

        // Validate file type
        if (!file.type.match('image/(jpeg|jpg|png)')) {
            alert('Por favor selecciona una imagen en formato JPG, JPEG o PNG.');
            return;
        }

        // Validate file size (2MB)
        if (file.size > 2 * 1024 * 1024) {
            alert('La imagen es demasiado grande. El tamaño máximo es 2MB.');
            return;
        }

        // Read file and show in cropper modal
        const reader = new FileReader();
        reader.onload = function (event) {
            cropperImage.src = event.target.result;
            cropperModal.show();

            // Initialize cropper when modal is shown
            document.getElementById('cropperModal').addEventListener('shown.bs.modal', function () {
                if (cropper) {
                    cropper.destroy();
                }

                cropper = new Cropper(cropperImage, {
                    aspectRatio: 1, // Square crop
                    viewMode: 2,
                    autoCropArea: 1,
                    responsive: true,
                    background: false,
                    zoomable: true,
                    scalable: true,
                    cropBoxResizable: true,
                    cropBoxMovable: true,
                });
            }, { once: true });
        };
        reader.readAsDataURL(file);
    });

    // Apply crop
    applyCropBtn.addEventListener('click', function () {
        if (!cropper) return;

        cropper.getCroppedCanvas({
            width: 800,
            height: 800,
            imageSmoothingEnabled: true,
            imageSmoothingQuality: 'high',
        }).toBlob(function (blob) {
            croppedBlob = blob;

            // Create a new File object from the blob
            const fileName = imageInput.files[0].name;
            const croppedFile = new File([blob], fileName, {
                type: blob.type,
                lastModified: Date.now()
            });

            // Use DataTransfer to replace the file in the input
            const dataTransfer = new DataTransfer();
            dataTransfer.items.add(croppedFile);
            imageInput.files = dataTransfer.files;

            // Show preview
            const previewUrl = URL.createObjectURL(blob);
            imagePreview.src = previewUrl;
            imagePreviewContainer.style.display = 'block';
            imagePreviewContainer.classList.add('has-image');

            // Close modal
            cropperModal.hide();

            // Destroy cropper
            if (cropper) {
                cropper.destroy();
                cropper = null;
            }
        }, 'image/jpeg', 0.95);
    });

    // Clean up when modal is hidden
    document.getElementById('cropperModal').addEventListener('hidden.bs.modal', function () {
        if (cropper) {
            cropper.destroy();
            cropper = null;
        }
    });

    /**
     * Formatea un número en estilo argentino "Smart":
     * - Separador de miles: punto (.)
     * - Separador decimal: coma (,)
     * - Elimina ceros decimales innecesarios
     */
    function formatSmartAr(value) {
        if (value === null || value === undefined || value === '' || isNaN(value)) return '';

        const num = parseFloat(value);
        // Siempre mostrar 2 decimales, incluso si es 0 -> "0,00"

        // Separar parte entera y decimal
        let [integerPart, decimalPart] = num.toFixed(2).split('.');

        // Formatear parte entera con separador de miles
        integerPart = integerPart.replace(/\B(?=(\d{3})+(?!\d))/g, '.');

        // Construir resultado siempre con coma y decimales
        return `${integerPart},${decimalPart}`;
    }

    /**
     * Convierte formato argentino a número para inputs
     */
    function parseArToNumber(value) {
        if (!value) return '';
        // Eliminar puntos (separador de miles) y reemplazar coma por punto
        return value.toString().replace(/\./g, '').replace(',', '.');
    }

    /**
     * Formatea un precio en formato argentino con 2 decimales SIEMPRE:
     * - Separador de miles: punto (.)
     * - Separador decimal: coma (,)
     * - Siempre muestra 2 decimales (ej: 1.500,00)
     */
    function formatPriceAr(value) {
        if (value === null || value === undefined || value === '' || isNaN(value)) return '';

        const num = parseFloat(value);

        // Separar parte entera y decimal (siempre 2 decimales)
        let [integerPart, decimalPart] = num.toFixed(2).split('.');

        // Formatear parte entera con separador de miles
        integerPart = integerPart.replace(/\B(?=(\d{3})+(?!\d))/g, '.');

        // Construir resultado con 2 decimales siempre
        return `${integerPart},${decimalPart}`;
    }

    document.addEventListener('DOMContentLoaded', function () {
        const costInput = document.getElementById('cost');
        const salePriceInput = document.getElementById('sale_price');

        // Formatear costo al perder el foco
        // Formatear costo al perder el foco
        if (costInput) {
            costInput.addEventListener('blur', function () {
                let val = this.value;
                if (!val) {
                    this.value = '0,00';
                    return;
                }

                // Parsear: reemplazar coma por punto para obtener float
                let cleanVal = val.replace(/\./g, '').replace(',', '.');
                let numValue = parseFloat(cleanVal);

                if (!isNaN(numValue)) {
                    this.value = formatSmartAr(numValue);
                } else {
                    this.value = '0,00';
                }
            });

            costInput.addEventListener('focus', function () {
                let val = this.value;
                if (val) {
                    this.value = val.replace(/\./g, '');
                    if (this.value === '0,00' || this.value === '0') {
                        this.value = '';
                    }
                }
                this.type = 'text';
                this.select();
            });

            costInput.addEventListener('input', function () {
                this.value = this.value.replace(/[^0-9,]/g, '');
                if ((this.value.match(/,/g) || []).length > 1) {
                    this.value = this.value.replace(/,$/, '');
                }
            });
        }

        // Formatear precio de venta al perder el foco
        if (salePriceInput) {
            salePriceInput.addEventListener('blur', function () {
                let val = this.value;
                if (!val) {
                    this.value = '0,00';
                    return;
                }

                // Parsear: reemplazar coma por punto para obtener float
                let cleanVal = val.replace(/\./g, '').replace(',', '.');
                let numValue = parseFloat(cleanVal);

                if (!isNaN(numValue)) {
                    this.value = formatSmartAr(numValue);
                } else {
                    this.value = '0,00';
                }
            });

            salePriceInput.addEventListener('focus', function () {
                let val = this.value;
                if (val) {
                    this.value = val.replace(/\./g, '');
                    if (this.value === '0,00' || this.value === '0') {
                        this.value = '';
                    }
                }
                this.type = 'text';
                this.select();
            });

            salePriceInput.addEventListener('input', function () {
                this.value = this.value.replace(/[^0-9,]/g, '');
                if ((this.value.match(/,/g) || []).length > 1) {
                    this.value = this.value.replace(/,$/, '');
                }
            });
        }



        // Antes de enviar el formulario, restaurar valores numéricos
        const form = document.querySelector('form');
        if (form) {
            form.addEventListener('submit', function (e) {
                if (costInput && costInput.type === 'text') {
                    const rawValue = costInput.getAttribute('data-raw-value');
                    if (rawValue) {
                        costInput.type = 'number';
                        costInput.value = rawValue;
                    } else {
                        costInput.value = parseArToNumber(costInput.value);
                        costInput.type = 'number';
                    }
                }

                if (salePriceInput && salePriceInput.type === 'text') {
                    const rawValue = salePriceInput.getAttribute('data-raw-value');
                    if (rawValue) {
                        salePriceInput.type = 'number';
                        salePriceInput.value = rawValue;
                    } else {
                        salePriceInput.value = parseArToNumber(salePriceInput.value);
                        salePriceInput.type = 'number';
                    }
                }
            });
        }
    });
</script>
{% endblock %}