{% extends "base.html" %}

{% block title %}
{% if action == 'new' %}Nuevo Producto{% else %}Editar Producto{% endif %} - Sistema de Gestión
{% endblock %}

{% block page_title %}{% if action == 'new' %}Nuevo Producto{% else %}Editar Producto{% endif %}{% endblock %}

{% block topbar_actions %}
<a href="{{ url_for('catalog.list_products') }}" class="btn-custom btn-secondary-custom">
    <i class="bi bi-arrow-left"></i> Volver
</a>
{% endblock %}

{% block content %}
<!-- Alert if no UOMs available -->
{% if not uoms or uoms|length == 0 %}
<div class="alert-custom alert-warning" style="margin-bottom: var(--spacing-6);">
    <i class="alert-custom-icon bi bi-exclamation-triangle"></i>
    <div class="alert-custom-content">
        <strong>No hay unidades de medida registradas.</strong>
        <p style="margin: var(--spacing-1) 0 0 0;">Debe crear al menos una unidad de medida antes de poder crear
            productos.</p>
        <a href="{{ url_for('settings.list_uoms') }}"
            style="color: inherit; font-weight: var(--font-weight-bold); margin-top: var(--spacing-2); display: inline-block;">
            <i class="bi bi-plus-circle"></i> Ir a Unidades de Medida
        </a>
    </div>
</div>
{% endif %}

<div style="display: grid; grid-template-columns: 1fr 340px; gap: var(--spacing-6);">
    <div>
        <div class="card-custom">
            <div class="card-header-custom">
                <h2 class="card-title">
                    {{ 'Crear Nuevo Producto' if action == 'new' else 'Editar Producto' }}
                </h2>
            </div>
            <div class="card-body-custom">
                <form method="POST"
                    action="{% if action == 'new' %}{{ url_for('catalog.create_product') }}{% else %}{{ url_for('catalog.update_product', product_id=product.id) }}{% endif %}"
                    enctype="multipart/form-data">

                    <!-- Name -->
                    <div class="form-group">
                        <label for="name" class="form-label-custom">
                            Nombre <span style="color: var(--color-danger);">*</span>
                        </label>
                        <input type="text" class="form-input-custom" id="name" name="name"
                            value="{{ product.name if product else '' }}" required maxlength="255"
                            placeholder="Ej: Producto A" autocomplete="off"
                            style="font-size: var(--font-size-lg); font-weight: var(--font-weight-medium);">
                    </div>

                    <!-- SKU and Barcode -->
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: var(--spacing-4);">
                        <div class="form-group">
                            <label for="sku" class="form-label-custom">SKU</label>
                            <input type="text" class="form-input-custom" id="sku" name="sku"
                                value="{{ product.sku if product else '' }}" maxlength="100"
                                placeholder="Código interno" autocomplete="off"
                                hx-post="{{ url_for('catalog.check_sku') }}" hx-trigger="keyup changed delay:500ms"
                                hx-target="#sku-error-container" hx-swap="outerHTML" hx-include="[name='product_id']">
                            <input type="hidden" name="product_id" value="{{ product.id if product else '' }}">
                            <div id="sku-error-container"></div>
                        </div>
                        <div class="form-group">
                            <label for="barcode" class="form-label-custom">Código de Barras</label>
                            <input type="text" class="form-input-custom" id="barcode" name="barcode"
                                value="{{ product.barcode if product else '' }}" maxlength="100"
                                placeholder="EAN-13 / UPC" autocomplete="off">
                        </div>
                    </div>

                    <!-- Category and UOM -->
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: var(--spacing-4);">
                        <div class="form-group">
                            <label for="category_id" class="form-label-custom">Categoría</label>
                            <select class="form-select-custom" id="category_id" name="category_id">
                                <option value="">Sin categoría</option>
                                {% for category in categories %}
                                <option value="{{ category.id }}" {% if product and product.category_id==category.id
                                    %}selected{% endif %}>
                                    {{ category.name }}
                                </option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="uom_id" class="form-label-custom">
                                Unidad de Medida <span style="color: var(--color-danger);">*</span>
                            </label>
                            <select class="form-select-custom" id="uom_id" name="uom_id" required {% if not uoms or
                                uoms|length==0 %}disabled{% endif %}>
                                <option value="">{% if uoms and uoms|length > 0 %}Seleccione una unidad{% else %}Sin
                                    unidades disponibles{% endif %}</option>
                                {% for uom in uoms %}
                                <option value="{{ uom.id }}" {% if product and product.uom_id==uom.id %}selected{% endif
                                    %}>
                                    {{ uom.name }} ({{ uom.symbol }})
                                </option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>

                    <hr style="border-color: var(--color-border-light); margin: var(--spacing-6) 0;">

                    <!-- Pricing Section -->
                    <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: var(--spacing-4);">
                        <div class="form-group">
                            <label for="cost" class="form-label-custom">
                                Costo (Precio de Compra)
                            </label>
                            <div style="position: relative;">
                                <span
                                    style="position: absolute; left: 12px; top: 50%; transform: translateY(-50%); color: var(--color-text-muted);">$</span>
                                <input type="text" class="form-input-custom no-spinner" id="cost" name="cost"
                                    value="{% if product and product.cost %}{{ '{:,.2f}'.format(product.cost).replace(',', 'X').replace('.', ',').replace('X', '.') }}{% else %}0,00{% endif %}"
                                    inputmode="decimal"
                                    onfocus="if(this.value === '0,00' || this.value === '0') this.value = '';"
                                    onblur="if(this.value === '') this.value = '0,00';"
                                    style="padding-left: 28px; color: var(--color-text-secondary);"
                                    placeholder="1.000,00">
                            </div>
                        </div>

                        <div class="form-group">
                            <label for="sale_price" class="form-label-custom">
                                Precio de Venta <span style="color: var(--color-danger);">*</span>
                            </label>
                            <div style="position: relative;">
                                <span
                                    style="position: absolute; left: 12px; top: 50%; transform: translateY(-50%); color: var(--color-text-muted);">$</span>
                                <input type="text" class="form-input-custom no-spinner" id="sale_price"
                                    name="sale_price"
                                    value="{% if product and product.sale_price %}{{ '{:,.2f}'.format(product.sale_price).replace(',', 'X').replace('.', ',').replace('X', '.') }}{% else %}0,00{% endif %}"
                                    inputmode="decimal" required
                                    onfocus="if(this.value === '0,00' || this.value === '0') this.value = '';"
                                    onblur="if(this.value === '') this.value = '0,00';"
                                    style="padding-left: 28px; font-weight: var(--font-weight-bold); color: var(--color-success);"
                                    placeholder="1.000,00">
                            </div>
                        </div>

                        <div class="form-group">
                            <label for="min_stock_qty" class="form-label-custom">
                                Stock Mínimo
                            </label>
                            <input type="number" class="form-input-custom" id="min_stock_qty" name="min_stock_qty"
                                value="{{ product.min_stock_qty | int if (product and product.min_stock_qty) else '' }}"
                                step="1" min="0" autocomplete="off">
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="form-label-custom">Estado</label>
                        <div style="display: flex; align-items: center; gap: var(--spacing-2);">
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" id="active" name="active" {% if not
                                    product or product.active %}checked{% endif %}>
                                <label class="form-check-label" for="active" style="cursor: pointer;">
                                    Producto activo (visible en ventas)
                                </label>
                            </div>
                        </div>
                    </div>

                    <hr style="border-color: var(--color-border-light); margin: var(--spacing-6) 0;">

                    <!-- Product Image -->
                    <div class="form-group">
                        <label for="image" class="form-label-custom">Imagen del Producto</label>
                        {% if product and product.image_path %}
                        <div style="margin-bottom: var(--spacing-4);">
                            <div
                                style="border: 1px solid var(--color-border-medium); padding: var(--spacing-2); display: inline-block; border-radius: var(--radius-md); background-color: white;">
                                <img src="{{ product.image_path }}" alt="{{ product.name }}"
                                    style="max-width: 150px; height: auto; display: block;">
                            </div>
                            <p
                                style="margin: var(--spacing-1) 0 0 0; font-size: var(--font-size-xs); color: var(--color-text-muted);">
                                Imagen actual</p>
                        </div>
                        {% endif %}
                        <input type="file" class="form-input-custom" id="image" name="image"
                            accept="image/jpeg,image/jpg,image/png">
                        <small
                            style="color: var(--color-text-muted); font-size: var(--font-size-xs); margin-top: var(--spacing-1); display: block;">
                            Formatos permitidos: JPG, JPEG, PNG. Tamaño máximo: 2MB.
                            {% if product and product.image_path %}
                            Subir una imagen reemplazará la actual.
                            {% endif %}
                        </small>
                    </div>

                    {% if product and product.id %}
                    <!-- Stock Info (read-only) -->
                    <div class="alert-custom alert-info" style="margin-top: var(--spacing-6);">
                        <i class="alert-custom-icon bi bi-info-circle"></i>
                        <div class="alert-custom-content">
                            <strong>Stock actual:</strong>
                            {{ "%.2f"|format(product.on_hand_qty) }} {{ product.uom.symbol }}
                        </div>
                    </div>
                    {% endif %}

                    <!-- Actions -->
                    <div
                        style="display: flex; justify-content: flex-end; gap: var(--spacing-2); margin-top: var(--spacing-6);">
                        <a href="{{ url_for('catalog.list_products') }}" class="btn-custom btn-secondary-custom">
                            <i class="bi bi-x-circle"></i> Cancelar
                        </a>
                        <button type="submit" id="save-product-btn" class="btn-custom btn-primary-custom" {% if not uoms
                            or uoms|length==0 %}disabled style="opacity: 0.5; cursor: not-allowed;" {% endif %}>
                            <i class="bi bi-save"></i>
                            {% if action == 'new' %}Crear Producto{% else %}Guardar Cambios{% endif %}
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Help Card -->
    <div>
        <div class="card-custom" style="background-color: var(--color-bg-muted);">
            <div class="card-header-custom">
                <h2 class="card-title" style="font-size: var(--font-size-sm);">
                    <i class="bi bi-question-circle"></i> Ayuda
                </h2>
            </div>
            <div class="card-body-custom">
                <h6 style="margin-bottom: var(--spacing-2); font-weight: var(--font-weight-semibold);">Campos
                    requeridos:</h6>
                <ul
                    style="font-size: var(--font-size-sm); color: var(--color-text-secondary); padding-left: var(--spacing-4); margin-bottom: var(--spacing-4);">
                    <li><strong>Nombre:</strong> Identificación del producto</li>
                    <li><strong>Unidad de Medida:</strong> Cómo se mide (UN, KG, M, etc.)</li>
                    <li><strong>Precio de Venta:</strong> Precio al público</li>
                </ul>

                <h6 style="margin-bottom: var(--spacing-2); font-weight: var(--font-weight-semibold);">Campos
                    opcionales:</h6>
                <ul
                    style="font-size: var(--font-size-sm); color: var(--color-text-secondary); padding-left: var(--spacing-4); margin: 0;">
                    <li><strong>SKU:</strong> Código interno único</li>
                    <li><strong>Código de Barras:</strong> Para escaneo</li>
                    <li><strong>Categoría:</strong> Para organizar productos</li>
                </ul>

                <hr style="border-color: var(--color-border-light); margin: var(--spacing-4) 0;">

                <div class="alert-custom alert-warning" style="margin: 0; padding: var(--spacing-3);">
                    <i class="alert-custom-icon bi bi-exclamation-triangle" style="font-size: var(--font-size-md);"></i>
                    <div class="alert-custom-content" style="font-size: var(--font-size-xs);">
                        El SKU y código de barras deben ser únicos si se proporcionan.
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    /**
     * Formatea un número en estilo argentino "Smart":
     * - Separador de miles: punto (.)
     * - Separador decimal: coma (,)
     * - Elimina ceros decimales innecesarios
     */
    function formatSmartAr(value) {
        if (value === null || value === undefined || value === '' || isNaN(value)) return '';

        const num = parseFloat(value);
        // Siempre mostrar 2 decimales, incluso si es 0 -> "0,00"

        // Separar parte entera y decimal
        let [integerPart, decimalPart] = num.toFixed(2).split('.');

        // Formatear parte entera con separador de miles
        integerPart = integerPart.replace(/\B(?=(\d{3})+(?!\d))/g, '.');

        // Construir resultado siempre con coma y decimales
        return `${integerPart},${decimalPart}`;
    }

    /**
     * Convierte formato argentino a número para inputs
     */
    function parseArToNumber(value) {
        if (!value) return '';
        // Eliminar puntos (separador de miles) y reemplazar coma por punto
        return value.toString().replace(/\./g, '').replace(',', '.');
    }

    /**
     * Formatea un precio en formato argentino con 2 decimales SIEMPRE:
     * - Separador de miles: punto (.)
     * - Separador decimal: coma (,)
     * - Siempre muestra 2 decimales (ej: 1.500,00)
     */
    function formatPriceAr(value) {
        if (value === null || value === undefined || value === '' || isNaN(value)) return '';

        const num = parseFloat(value);

        // Separar parte entera y decimal (siempre 2 decimales)
        let [integerPart, decimalPart] = num.toFixed(2).split('.');

        // Formatear parte entera con separador de miles
        integerPart = integerPart.replace(/\B(?=(\d{3})+(?!\d))/g, '.');

        // Construir resultado con 2 decimales siempre
        return `${integerPart},${decimalPart}`;
    }

    document.addEventListener('DOMContentLoaded', function () {
        const costInput = document.getElementById('cost');
        const salePriceInput = document.getElementById('sale_price');
        const minStockInput = document.getElementById('min_stock_qty');

        // Formatear costo al perder el foco
        if (costInput) {
            costInput.addEventListener('blur', function () {
                if (this.value && this.value !== '') {
                    const numValue = parseFloat(this.value);
                    if (!isNaN(numValue) && numValue > 0) {
                        // Mostrar formato visual temporalmente
                        const formatted = formatPriceAr(numValue);
                        this.setAttribute('data-raw-value', this.value);
                        this.value = formatted;
                        this.type = 'text';
                    } else if (this.value === '') {
                        this.value = '0,00';
                    }
                }
            });

            costInput.addEventListener('focus', function () {
                // Restaurar valor numérico para edición
                const rawValue = this.getAttribute('data-raw-value');
                if (rawValue) {
                    this.type = 'number';
                    this.value = rawValue;
                    this.removeAttribute('data-raw-value');
                }
                // Limpiar si es 0,00 o 0
                if (this.value === '0,00' || this.value === '0') {
                    this.value = '';
                }
            });
        }

        // Formatear precio de venta al perder el foco
        // Formatear precio de venta al perder el foco
        if (salePriceInput) {
            salePriceInput.addEventListener('blur', function () {
                let val = this.value;
                if (!val) {
                    this.value = '0,00';
                    return;
                }

                // Parsear: reemplazar coma por punto para obtener float
                // Si el usuario ingresó '1500,50' (sin puntos de miles), funciona.
                // Si ingresó '1.500,50' (con puntos), primero quitamos los puntos.
                let cleanVal = val.replace(/\./g, '').replace(',', '.');
                let numValue = parseFloat(cleanVal);

                if (!isNaN(numValue)) {
                    this.value = formatSmartAr(numValue);
                } else {
                    this.value = '0,00';
                }
            });

            salePriceInput.addEventListener('focus', function () {
                let val = this.value;
                // Al enfocar, quitamos los puntos de miles para dejar el número "limpio" pero con coma decimal
                // Ej: '1.500,00' -> '1500,00' para que sea fácil de editar
                if (val) {
                    this.value = val.replace(/\./g, '');

                    // Si es 0 o 0,00, limpiar para escribir directo
                    if (this.value === '0,00' || this.value === '0') {
                        this.value = '';
                    }
                }
                // Aseguramos que sea texto para evitar validación estricta de navegador
                this.type = 'text';
                this.select();
            });

            // Validación básica en input: solo números y coma
            salePriceInput.addEventListener('input', function () {
                // Reemplazar cualquier caracter que no sea número o coma
                this.value = this.value.replace(/[^0-9,]/g, '');

                // Evitar múltiples comas
                if ((this.value.match(/,/g) || []).length > 1) {
                    this.value = this.value.replace(/,$/, '');
                }

                // Limpiar si es 0,00 o 0
                if (this.value === '0,00' || this.value === '0') {
                    this.value = '';
                }
            });
        }

        // Formatear stock mínimo al perder el foco
        if (minStockInput) {
            minStockInput.addEventListener('blur', function () {
                if (this.value && this.value !== '') {
                    const numValue = parseInt(this.value);
                    if (!isNaN(numValue) && numValue > 0) {
                        // Mostrar formato visual temporalmente
                        const formatted = formatSmartAr(numValue);
                        this.setAttribute('data-raw-value', this.value);
                        this.value = formatted;
                        this.type = 'text';
                    }
                }
            });

            minStockInput.addEventListener('focus', function () {
                // Restaurar valor numérico para edición
                const rawValue = this.getAttribute('data-raw-value');
                if (rawValue) {
                    this.type = 'number';
                    this.value = rawValue;
                    this.removeAttribute('data-raw-value');
                }
            });
        }

        // Antes de enviar el formulario, restaurar valores numéricos
        const form = document.querySelector('form');
        if (form) {
            form.addEventListener('submit', function (e) {
                if (costInput && costInput.type === 'text') {
                    const rawValue = costInput.getAttribute('data-raw-value');
                    if (rawValue) {
                        costInput.type = 'number';
                        costInput.value = rawValue;
                    } else {
                        // Convertir formato argentino a número
                        costInput.value = parseArToNumber(costInput.value);
                        costInput.type = 'number';
                    }
                }

                if (salePriceInput && salePriceInput.type === 'text') {
                    const rawValue = salePriceInput.getAttribute('data-raw-value');
                    if (rawValue) {
                        salePriceInput.type = 'number';
                        salePriceInput.value = rawValue;
                    } else {
                        // Convertir formato argentino a número
                        salePriceInput.value = parseArToNumber(salePriceInput.value);
                        salePriceInput.type = 'number';
                    }
                }

                if (minStockInput && minStockInput.type === 'text') {
                    const rawValue = minStockInput.getAttribute('data-raw-value');
                    if (rawValue) {
                        minStockInput.type = 'number';
                        minStockInput.value = rawValue;
                    } else {
                        // Convertir formato argentino a número
                        minStockInput.value = parseArToNumber(minStockInput.value);
                        minStockInput.type = 'number';
                    }
                }
            });
        }
    });
</script>

<style>
    /* Ocultar spinners (flechas) en inputs de precio */
    .no-spinner::-webkit-outer-spin-button,
    .no-spinner::-webkit-inner-spin-button {
        -webkit-appearance: none;
        margin: 0;
    }

    .no-spinner[type=number] {
        -moz-appearance: textfield;
    }
</style>
{% endblock %}