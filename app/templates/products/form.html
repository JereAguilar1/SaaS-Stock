{% extends "base.html" %}

{% block title %}
{% if action == 'new' %}Nuevo Producto{% else %}Editar Producto{% endif %} - Sistema de Gestión
{% endblock %}

{% block page_title %}{% if action == 'new' %}Nuevo Producto{% else %}Editar Producto{% endif %}{% endblock %}

{% block topbar_actions %}
<a href="{{ url_for('catalog.list_products') }}" class="btn-custom btn-secondary-custom">
    <i class="bi bi-arrow-left"></i> Volver
</a>
{% endblock %}

{% block extra_css %}
<!-- Cropper.js CSS -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.6.1/cropper.min.css">
<style>
    /* Ocultar spinners (flechas) en inputs de precio */
    .no-spinner::-webkit-outer-spin-button,
    .no-spinner::-webkit-inner-spin-button {
        -webkit-appearance: none;
        margin: 0;
    }

    .no-spinner[type=number] {
        -moz-appearance: textfield;
    }

    /* Image preview styles */
    .image-preview-container {
        margin-top: var(--spacing-3);
        border: 2px dashed var(--color-border-medium);
        border-radius: var(--radius-md);
        padding: var(--spacing-4);
        text-align: center;
        background-color: var(--color-bg-muted);
    }

    .image-preview-container img {
        max-width: 200px;
        max-height: 200px;
        border-radius: var(--radius-md);
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }

    .image-preview-container.has-image {
        border-color: var(--color-success);
        background-color: var(--color-success-light);
    }
</style>
{% endblock %}

{% block content %}
<!-- Alert if no UOMs available -->
{% if not uoms or uoms|length == 0 %}
<div class="alert-custom alert-warning" style="margin-bottom: var(--spacing-6);">
    <i class="alert-custom-icon bi bi-exclamation-triangle"></i>
    <div class="alert-custom-content">
        <strong>No hay unidades de medida registradas.</strong>
        <p style="margin: var(--spacing-1) 0 0 0;">Debe crear al menos una unidad de medida antes de poder crear
            productos.</p>
        <a href="{{ url_for('settings.list_uoms') }}"
            style="color: inherit; font-weight: var(--font-weight-bold); margin-top: var(--spacing-2); display: inline-block;">
            <i class="bi bi-plus-circle"></i> Ir a Unidades de Medida
        </a>
    </div>
</div>
{% endif %}

<div style="display: grid; grid-template-columns: 1fr 340px; gap: var(--spacing-6);">
    <div>
        <div class="card-custom">
            <div class="card-header-custom">
                <h2 class="card-title">
                    {{ 'Crear Nuevo Producto' if action == 'new' else 'Editar Producto' }}
                </h2>
            </div>
            <div class="card-body-custom">
                <form method="POST"
                    action="{% if action == 'new' %}{{ url_for('catalog.create_product') }}{% else %}{{ url_for('catalog.update_product', product_id=product.id) }}{% endif %}"
                    enctype="multipart/form-data">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">

                    <!-- Name -->
                    <div class="form-group">
                        <label for="name" class="form-label-custom">
                            Nombre <span style="color: var(--color-danger);">*</span>
                        </label>
                        <input type="text" class="form-input-custom" id="name" name="name"
                            value="{{ product.name if product else (request.args.get('name', '') if action == 'new' else '') }}"
                            required maxlength="255" placeholder="Nombre del producto" autocomplete="off"
                            style="font-size: var(--font-size-lg); font-weight: var(--font-weight-medium);">
                    </div>

                    <!-- SKU and Barcode -->
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: var(--spacing-4);">
                        <div class="form-group">
                            <label for="sku" class="form-label-custom">SKU</label>
                            <input type="text" class="form-input-custom" id="sku" name="sku"
                                value="{{ product.sku or '' if product else '' }}" maxlength="100"
                                placeholder="Código interno" autocomplete="off"
                                hx-post="{{ url_for('catalog.check_sku') }}" hx-trigger="keyup changed delay:500ms"
                                hx-target="#sku-error-container" hx-swap="outerHTML" hx-include="[name='product_id']">
                            <input type="hidden" name="product_id" value="{{ product.id or '' if product else '' }}">
                            <div id="sku-error-container"></div>
                        </div>
                        <div class="form-group">
                            <label for="barcode" class="form-label-custom">Código de Barras</label>
                            <input type="text" class="form-input-custom" id="barcode" name="barcode"
                                value="{{ product.barcode or '' if product else '' }}" maxlength="100"
                                placeholder="EAN / UPC" autocomplete="off">
                        </div>
                    </div>

                    <!-- Category and UOM -->
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: var(--spacing-4);">
                        <div class="form-group">
                            <label class="form-label-custom">Categoría</label>
                            <div style="display: flex; gap: var(--spacing-2); align-items: flex-start;">
                                <select class="form-select-custom" id="category_id" name="category_id">
                                    {% include 'products/_category_selector_options.html' %}
                                </select>
                                <button type="button" class="btn-custom btn-secondary-custom"
                                    hx-get="{{ url_for('settings.quick_create_category') }}"
                                    hx-target="#modal-container"
                                    style="padding: 0 var(--spacing-3); height: 42px; flex-shrink: 0;"
                                    title="Nueva Categoría">
                                    <i class="bi bi-plus-lg"></i>
                                </button>
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="form-label-custom">Unidad de Medida <span
                                    style="color: var(--color-danger);">*</span></label>
                            <div style="display: flex; gap: var(--spacing-2); align-items: flex-start;">
                                <!-- Selector target ID used by HTMX OOB swap -->
                                <select class="form-select-custom" id="uom_id" name="uom_id" required {% if not uoms or
                                    uoms|length==0 %}disabled{% endif %}>
                                    {% with selected_uom_id = product.uom_id if product else None %}
                                    {% include 'products/_uom_selector_options.html' %}
                                    {% endwith %}
                                </select>
                                <button type="button" class="btn-custom btn-secondary-custom"
                                    hx-get="{{ url_for('settings.quick_create_uom') }}" hx-target="#modal-container"
                                    style="padding: 0 var(--spacing-3); height: 42px; flex-shrink: 0;"
                                    title="Nueva Unidad de Medida">
                                    <i class="bi bi-plus-lg"></i>
                                </button>
                            </div>
                        </div>
                    </div>

                    <hr style="border-color: var(--color-border-light); margin: var(--spacing-6) 0;">

                    <!-- Unified Pricing & Stock Grid -->
                    <div
                        style="display: grid; grid-template-columns: 1fr 1fr; gap: var(--spacing-4); align-items: start;">
                        <!-- 1. Cost -->
                        <div class="form-group">
                            <label for="cost" class="form-label-custom">
                                Costo (Precio de Compra)
                            </label>
                            <div style="position: relative;">
                                <span
                                    style="position: absolute; left: 12px; top: 50%; transform: translateY(-50%); color: var(--color-text-muted);">$</span>
                                <input type="text" class="form-input-custom no-spinner" id="cost" name="cost"
                                    value="{% if product and product.cost %}{{ '{:,.2f}'.format(product.cost).replace(',', 'X').replace('.', ',').replace('X', '.') }}{% else %}0,00{% endif %}"
                                    inputmode="decimal" autocomplete="off"
                                    onfocus="if(this.value === '0,00' || this.value === '0') this.value = '';"
                                    onblur="if(this.value === '') this.value = '0,00';"
                                    style="padding-left: 28px; color: var(--color-text-secondary);" placeholder="0,00">
                            </div>
                        </div>

                        <!-- 2. Sale Price -->
                        <div class="form-group">
                            <label for="sale_price" class="form-label-custom">
                                Precio de Venta <span style="color: var(--color-danger);">*</span>
                            </label>
                            <div style="position: relative;">
                                <span
                                    style="position: absolute; left: 12px; top: 50%; transform: translateY(-50%); color: var(--color-text-muted);">$</span>
                                <input type="text" class="form-input-custom no-spinner" id="sale_price"
                                    name="sale_price"
                                    value="{% if product and product.sale_price %}{{ '{:,.2f}'.format(product.sale_price).replace(',', 'X').replace('.', ',').replace('X', '.') }}{% else %}0,00{% endif %}"
                                    inputmode="decimal" required autocomplete="off"
                                    onfocus="if(this.value === '0,00' || this.value === '0') this.value = '';"
                                    onblur="if(this.value === '') this.value = '0,00';"
                                    style="padding-left: 28px; font-weight: var(--font-weight-bold); color: var(--color-success);"
                                    placeholder="0,00">
                            </div>
                        </div>

                        <!-- 3. Min Stock -->
                        <div class="form-group">
                            <label for="min_stock_qty" class="form-label-custom">
                                Stock Mínimo
                            </label>
                            <input type="number" class="form-input-custom" id="min_stock_qty" name="min_stock_qty"
                                value="{{ product.min_stock_qty | int if product and product.min_stock_qty is not none else '' }}"
                                step="1" min="0" autocomplete="off" placeholder="0"
                                oninput="if(this.value < 0) this.value = 0; this.value = Math.floor(this.value);"
                                style="font-family: monospace;">
                        </div>

                        <!-- 4. Initial Stock (Only New) -->
                        {% if action == 'new' %}
                        <div class="form-group">
                            <label for="initial_stock" class="form-label-custom">
                                Stock Actual (Inicial)
                            </label>
                            <input type="number" class="form-input-custom" id="initial_stock" name="initial_stock"
                                value="{{ product.initial_stock or '' if product and product.initial_stock is not none else '' }}"
                                step="1" min="0" autocomplete="off" placeholder="0"
                                oninput="if(this.value < 0) this.value = 0; this.value = Math.floor(this.value);"
                                style="font-family: monospace;">
                        </div>
                        {% endif %}

                        <!-- 5. Stock Actual (Editable - Only Edit) -->
                        {% if action == 'edit' %}
                        <div class="form-group">
                            <label for="on_hand_qty" class="form-label-custom">
                                Stock Actual
                            </label>
                            <div style="position: relative;">
                                <input type="text" class="form-input-custom no-spinner" id="on_hand_qty"
                                    name="on_hand_qty"
                                    value="{{ '{:,.2f}'.format(product.on_hand_qty).replace(',', 'X').replace('.', ',').replace('X', '.') if product else '0,00' }}"
                                    inputmode="decimal" required autocomplete="off"
                                    onfocus="if(this.value === '0,00' || this.value === '0') this.value = '';"
                                    onblur="if(this.value === '') this.value = '0,00';"
                                    style="font-family: monospace; font-weight: bold;">
                                <small
                                    style="color: var(--color-text-muted); font-size: var(--font-size-xs); display: block; margin-top: 4px;">
                                    Modificar ajusta el stock.
                                </small>
                            </div>
                        </div>
                        {% endif %}
                    </div>

                    <hr style="border-color: var(--color-border-light); margin: var(--spacing-6) 0;">

                    <!-- Product Features Section -->
                    <div class="form-group">
                        <div
                            style="display: flex; justify-content: space-between; align-items: center; margin-bottom: var(--spacing-3);">
                            <label class="form-label-custom" style="margin-bottom: 0;">
                                Características / Especificaciones
                            </label>
                            <button type="button" class="btn-custom btn-secondary-custom btn-sm" id="addFeatureBtn">
                                <i class="bi bi-plus-lg"></i> Agregar Característica
                            </button>
                        </div>

                        <div id="featuresContainer"
                            style="display: flex; flex-direction: column; gap: var(--spacing-3); margin-bottom: var(--spacing-3);">
                            {% if product and product.features %}
                            {% for feature in product.features %}
                            <div class="feature-row"
                                style="display: grid; grid-template-columns: 1fr 1fr 40px; gap: var(--spacing-3); align-items: start;">
                                <input type="text" class="form-input-custom" name="features[{{ loop.index0 }}][title]"
                                    value="{{ feature.title }}" placeholder="Nombre de la característica" required>
                                <input type="text" class="form-input-custom"
                                    name="features[{{ loop.index0 }}][description]" value="{{ feature.description }}"
                                    placeholder="Descripción de la característica" required>
                                <button type="button"
                                    class="btn-custom btn-ghost-custom btn-sm text-danger remove-feature-btn"
                                    title="Eliminar">
                                    <i class="bi bi-trash"></i>
                                </button>
                            </div>
                            {% endfor %}
                            {% endif %}
                        </div>

                        <div id="noFeaturesMsg"
                            style="{% if product and product.features %}display: none;{% endif %} text-align: center; padding: var(--spacing-4); background-color: var(--color-bg-muted); border-radius: var(--radius-md); border: 1px dashed var(--color-border-medium);">
                            <p style="margin: 0; font-size: var(--font-size-sm); color: var(--color-text-muted);">
                                No hay características agregadas. Use el botón superior para agregar especificaciones
                                como color, talle, etc.
                            </p>
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="form-label-custom">Estado</label>
                        <div style="display: flex; align-items: center; gap: var(--spacing-2);">
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" id="active" name="active" {% if not
                                    product or product.active %}checked{% endif %}>
                                <label class="form-check-label" for="active" style="cursor: pointer;">
                                    Producto activo (visible en ventas)
                                </label>
                            </div>
                        </div>
                    </div>

                    <hr style="border-color: var(--color-border-light); margin: var(--spacing-6) 0;">


                    <!-- Product Image -->
                    <div class="form-group">
                        <label for="image" class="form-label-custom">Imagen del Producto</label>

                        <!-- Current Image Preview -->
                        <div id="currentImageContainer"
                            style="margin-bottom: var(--spacing-4); {% if not product or not product.image_path %}display: none;{% endif %}">
                            <div
                                style="border: 1px solid var(--color-border-medium); padding: var(--spacing-2); display: inline-block; border-radius: var(--radius-md); background-color: white; position: relative;">
                                <img id="currentImage"
                                    src="{{ product.image_url if product and product.image_url else '' }}"
                                    alt="Imagen actual" style="max-width: 150px; height: auto; display: block;">
                            </div>
                            <div style="margin-top: var(--spacing-2); display: flex; gap: var(--spacing-2);">
                                <button type="button" class="btn-custom btn-secondary-custom btn-sm"
                                    id="editExistingImageBtn"
                                    data-original-url="{{ product.image_original_url if product and product.image_original_url else (product.image_url if product and product.image_url else '') }}">
                                    <i class="bi bi-pencil-square"></i> Editar/Recortar
                                </button>

                                {% if product and product.image_original_path %}
                                <button type="button" class="btn-custom btn-ghost-custom btn-sm text-warning"
                                    id="restoreImageBtn" title="Restaurar a la imagen original sin recortes"
                                    data-restore-url="{{ url_for('catalog.restore_product_image', product_id=product.id) }}">
                                    <i class="bi bi-arrow-counterclockwise"></i> Restaurar
                                </button>
                                {% endif %}
                            </div>
                            <p
                                style="margin: var(--spacing-1) 0 0 0; font-size: var(--font-size-xs); color: var(--color-text-muted);">
                                Imagen actual
                            </p>
                        </div>

                        <!-- Hidden file input -->
                        <input type="file" class="form-input-custom" id="image" name="image"
                            accept="image/jpeg,image/jpg,image/png" style="display: none;">

                        <!-- Custom button to trigger file selection -->
                        <button type="button" class="btn-custom btn-secondary-custom" id="selectImageBtn">
                            <i class="bi bi-image"></i> Seleccionar Nueva Imagen
                        </button>

                        <!-- Image preview container (New/Edited Image) -->
                        <div id="imagePreviewContainer" class="image-preview-container" style="display: none;">
                            <img id="imagePreview" alt="Vista previa">
                            <p
                                style="margin-top: var(--spacing-2); font-size: var(--font-size-sm); color: var(--color-text-secondary);">
                                <i class="bi bi-check-circle"></i> Imagen lista para subir
                            </p>
                            <button type="button" class="btn-custom btn-ghost-custom btn-sm" id="changeImageBtn"
                                style="margin-top: var(--spacing-2);">
                                <i class="bi bi-arrow-repeat"></i> Cambiar imagen
                            </button>
                        </div>

                        <small
                            style="color: var(--color-text-muted); font-size: var(--font-size-xs); margin-top: var(--spacing-1); display: block;">
                            Formatos permitidos: JPG, JPEG, PNG. Tamaño máximo: 2MB.
                        </small>
                    </div>



                    <!-- Actions -->
                    <div
                        style="display: flex; justify-content: flex-end; gap: var(--spacing-2); margin-top: var(--spacing-6);">
                        <a href="{{ url_for('catalog.list_products') }}" class="btn-custom btn-secondary-custom">
                            <i class="bi bi-x-circle"></i> Cancelar
                        </a>
                        <button type="submit" class="btn-custom btn-primary-custom" {% if not uoms or uoms|length==0
                            %}disabled style="opacity: 0.5; cursor: not-allowed;" {% endif %}>
                            <i class="bi bi-save"></i>
                            {% if action == 'new' %}Crear Producto{% else %}Guardar Cambios{% endif %}
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Help Card -->
    <div>
        <div class="card-custom" style="background-color: var(--color-bg-muted);">
            <div class="card-header-custom">
                <h2 class="card-title" style="font-size: var(--font-size-sm);">
                    <i class="bi bi-question-circle"></i> Ayuda
                </h2>
            </div>
            <div class="card-body-custom">
                <h6 style="margin-bottom: var(--spacing-2); font-weight: var(--font-weight-semibold);">Campos
                    requeridos:</h6>
                <ul
                    style="font-size: var(--font-size-sm); color: var(--color-text-secondary); padding-left: var(--spacing-4); margin-bottom: var(--spacing-4);">
                    <li><strong>Nombre:</strong> Identificación del producto</li>
                    <li><strong>Unidad de Medida:</strong> Cómo se mide (UN, KG, M, etc.)</li>
                    <li><strong>Precio de Venta:</strong> Precio al público</li>
                </ul>

                <h6 style="margin-bottom: var(--spacing-2); font-weight: var(--font-weight-semibold);">Campos
                    opcionales:</h6>
                <ul
                    style="font-size: var(--font-size-sm); color: var(--color-text-secondary); padding-left: var(--spacing-4); margin: 0;">
                    <li><strong>SKU:</strong> Código interno único</li>
                    <li><strong>Código de Barras:</strong> Para escaneo</li>
                    <li><strong>Categoría:</strong> Para organizar productos</li>
                </ul>

                <hr style="border-color: var(--color-border-light); margin: var(--spacing-4) 0;">

                <div class="alert-custom alert-warning" style="margin: 0; padding: var(--spacing-3);">
                    <i class="alert-custom-icon bi bi-exclamation-triangle" style="font-size: var(--font-size-md);"></i>
                    <div class="alert-custom-content" style="font-size: var(--font-size-xs);">
                        El SKU y código de barras deben ser únicos si se proporcionan.
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Cropper Modal -->
<div class="modal fade" id="cropperModal" tabindex="-1" aria-labelledby="cropperModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="cropperModalLabel">
                    <i class="bi bi-crop"></i> Ajustar Imagen del Producto
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div style="max-height: 500px; overflow: hidden; background-color: #f8f9fa;">
                    <!-- Crossorigin anonymous is vital for editing existing S3 images -->
                    <img id="cropperImage" style="max-width: 100%; display: block;" crossorigin="anonymous">
                </div>

                <!-- Controls Toolkit -->
                <div class="d-flex justify-content-center gap-2 mt-3">
                    <div class="btn-group" role="group">
                        <button type="button" class="btn btn-outline-secondary" onclick="cropper.zoom(0.1)"
                            title="Zoom In">
                            <i class="bi bi-zoom-in"></i>
                        </button>
                        <button type="button" class="btn btn-outline-secondary" onclick="cropper.zoom(-0.1)"
                            title="Zoom Out">
                            <i class="bi bi-zoom-out"></i>
                        </button>
                    </div>
                    <div class="btn-group" role="group">
                        <button type="button" class="btn btn-outline-secondary" onclick="cropper.rotate(-90)"
                            title="Rotar Izquierda">
                            <i class="bi bi-arrow-counterclockwise"></i>
                        </button>
                        <button type="button" class="btn btn-outline-secondary" onclick="cropper.rotate(90)"
                            title="Rotar Derecha">
                            <i class="bi bi-arrow-clockwise"></i>
                        </button>
                    </div>
                </div>

                <div
                    style="margin-top: var(--spacing-3); padding: var(--spacing-2); background-color: var(--color-bg-muted); border-radius: var(--radius-md); text-align: center;">
                    <p style="margin: 0; font-size: var(--font-size-sm); color: var(--color-text-secondary);">
                        <i class="bi bi-info-circle"></i> Usa la rueda del mouse para zoom. Arrastra para mover.
                    </p>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn-custom btn-secondary-custom" data-bs-dismiss="modal">
                    <i class="bi bi-x-circle"></i> Cancelar
                </button>
                <button type="button" class="btn-custom btn-primary-custom" id="applyCrop">
                    <i class="bi bi-check-circle"></i> Confirmar Recorte
                </button>
            </div>
        </div>
    </div>
</div>

<!-- New UOM Modal Container -->
<!-- New UOM Modal Container -->
<!-- Generic Modal Container (Category, UOM, etc) -->
<div id="modal-container"></div>
{% endblock %}

{% block extra_js %}
<!-- Cropper.js -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.6.1/cropper.min.js"></script>

<script>
    // Listen for uomCreated event to close modal automatically
    document.body.addEventListener('uomCreated', function () {
        const modalEl = document.getElementById('uomModal');
        const modal = bootstrap.Modal.getInstance(modalEl);
        if (modal) {
            modal.hide();
        }

        // Remove 'disabled' attribute from select if it was there (handy for first creation)
        const select = document.getElementById('uom_id');
        if (select) {
            select.removeAttribute('disabled');
        }
    });
</script>


<script>
    // Image Cropper Logic
    let cropper = null;
    let croppedBlob = null;
    const productId = "{{ product.id if product else '' }}";

    const imageInput = document.getElementById('image');
    const selectImageBtn = document.getElementById('selectImageBtn');
    const changeImageBtn = document.getElementById('changeImageBtn');
    const editExistingImageBtn = document.getElementById('editExistingImageBtn');
    const cropperModal = new bootstrap.Modal(document.getElementById('cropperModal'));
    const cropperImage = document.getElementById('cropperImage');
    const applyCropBtn = document.getElementById('applyCrop');
    const imagePreviewContainer = document.getElementById('imagePreviewContainer');
    const imagePreview = document.getElementById('imagePreview');
    const currentImageContainer = document.getElementById('currentImageContainer');

    // Trigger file input when button is clicked
    selectImageBtn.addEventListener('click', () => {
        imageInput.click();
    });

    changeImageBtn.addEventListener('click', () => {
        imageInput.click();
    });

    // Edit Existing Image Logic
    if (editExistingImageBtn) {
        editExistingImageBtn.addEventListener('click', () => {
            const originalUrl = editExistingImageBtn.dataset.originalUrl;
            const currentImgSrc = document.getElementById('currentImage').src;

            // Prefer original URL for cropping to allow infinite edits
            const srcToLoad = originalUrl || currentImgSrc;

            if (srcToLoad) {
                // Set crossorigin BEFORE setting src to avoid tainted canvas
                cropperImage.crossOrigin = 'anonymous';
                cropperImage.src = srcToLoad;

                // Add a timestamp to bypass browser cache if needed, though usually not strictly necessary for viewing
                // cropperImage.src = currentImgSrc + '?t=' + new Date().getTime(); 

                cropperModal.show();
                initCropperInstance();
            }
        });
    }

    // Restore Image Logic
    const restoreBtn = document.getElementById('restoreImageBtn');
    if (restoreBtn) {
        restoreBtn.addEventListener('click', function () {
            if (confirm('¿Está seguro de restaurar la imagen original? Se perderá el recorte actual.')) {

                const originalContent = this.innerHTML;
                this.disabled = true;
                this.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Restaurando...';

                fetch(this.dataset.restoreUrl, {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': '{{ csrf_token() if csrf_token else "" }}' // Just in case, though not strictly required if not using CSRF extension yet
                    }
                })
                    .then(r => r.json())
                    .then(data => {
                        if (data.success) {
                            window.location.reload();
                        } else {
                            alert('Error: ' + (data.error || 'Error desconocido'));
                            this.disabled = false;
                            this.innerHTML = originalContent;
                        }
                    })
                    .catch(err => {
                        alert('Error de red: ' + err);
                        this.disabled = false;
                        this.innerHTML = originalContent;
                    });
            }
        });
    }

    // Handle file selection (New Image)
    imageInput.addEventListener('change', function (e) {
        const file = e.target.files[0];

        if (!file) return;

        // If it's the result of our own crop (programmatic change), ignore to avoid loop/re-crop
        // But here we want to allow re-cropping if user selects same file? 
        // We will just process any file user selects.

        // Validate file type
        if (!file.type.match('image/(jpeg|jpg|png|webp)')) {
            alert('Por favor selecciona una imagen en formato JPG, JPEG, PNG o WebP.');
            return;
        }

        // Validate file size (2MB)
        if (file.size > 2 * 1024 * 1024) {
            alert('La imagen es demasiado grande. El tamaño máximo es 2MB.');
            return;
        }

        // Read file and show in cropper modal
        const reader = new FileReader();
        reader.onload = function (event) {
            cropperImage.crossOrigin = 'anonymous'; // Good practice even for local files
            cropperImage.src = event.target.result;
            cropperModal.show();
            initCropperInstance();
        };
        reader.readAsDataURL(file);
    });

    function initCropperInstance() {
        // Wait for modal to be fully shown or just init if already visible logic
        // We use a small timeout or the modal event to ensure dimensions are correct
        const modalEl = document.getElementById('cropperModal');

        // If modal is not yet shown, wait for event
        if (!modalEl.classList.contains('show')) {
            modalEl.addEventListener('shown.bs.modal', function () {
                setupCropper();
            }, { once: true });
        } else {
            setupCropper(); // Modal already open (e.g. edit existing)
        }
    }

    function setupCropper() {
        if (cropper) {
            cropper.destroy();
        }

        cropper = new Cropper(cropperImage, {
            aspectRatio: 1, // Enforce 1:1 square crop to match thumbnails
            viewMode: 1, // Restrict crop box to not exceed canvas
            autoCropArea: 0.8,
            responsive: true,
            background: false,
            zoomable: true,
            scalable: true,
            rotatable: true,
            movable: true,
            cropBoxResizable: true,
            cropBoxMovable: true,
            checkCrossOrigin: true, // Check CORS
        });
    }

    // Apply crop
    applyCropBtn.addEventListener('click', function () {
        if (!cropper) return;

        // Get cropped canvas
        const canvas = cropper.getCroppedCanvas({
            // Set max dimensions if needed, or leave dynamic
            maxWidth: 1024,
            maxHeight: 1024,
            imageSmoothingEnabled: true,
            imageSmoothingQuality: 'high',
        });

        if (!canvas) {
            alert('No se pudo recortar la imagen. Intenta de nuevo.');
            return;
        }

        // Logic split: 
        // 1. If we have a NEW file selected (imageInput has files), use client-side blob logic.
        // 2. If we are editing an EXISTING confirmed image (imageInput empty + we have productId), use server-side crop.

        const hasNewFile = imageInput.files && imageInput.files.length > 0;

        if (!hasNewFile && productId) {
            // SERVER-SIDE CROP (Existing Product)
            const data = cropper.getData();

            const originalBtnContent = applyCropBtn.innerHTML;
            applyCropBtn.disabled = true;
            applyCropBtn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Guardando...';

            fetch(`/products/${productId}/crop`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: new URLSearchParams({
                    'x': data.x,
                    'y': data.y,
                    'width': data.width,
                    'height': data.height
                })
            })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        window.location.reload();
                    } else {
                        alert('Error: ' + (data.error || 'Unknown error'));
                        applyCropBtn.disabled = false;
                        applyCropBtn.innerHTML = originalBtnContent;
                    }
                })
                .catch(err => {
                    alert('Error de red: ' + err);
                    applyCropBtn.disabled = false;
                    applyCropBtn.innerHTML = originalBtnContent;
                });

            return; // Stop execution here, let fetch handle it
        }

        // CLIENT-SIDE CROP (New Upload or New Product)
        canvas.toBlob(function (blob) {
            if (!blob) return;

            croppedBlob = blob;

            // Determine file name
            let fileName = 'imagen_editada.jpg';
            if (imageInput.files[0]) {
                fileName = imageInput.files[0].name;
            } else {
                // If editing existing image, we simulate a name
                fileName = 'edited_product.jpg';
            }

            // Create a new File object from the blob
            const croppedFile = new File([blob], fileName, {
                type: 'image/jpeg',
                lastModified: Date.now()
            });

            // Use DataTransfer to replace/set the file in the input
            const dataTransfer = new DataTransfer();
            dataTransfer.items.add(croppedFile);
            imageInput.files = dataTransfer.files;

            // Show preview
            const previewUrl = URL.createObjectURL(blob);
            imagePreview.src = previewUrl;
            imagePreviewContainer.style.display = 'block';
            imagePreviewContainer.classList.add('has-image');

            // Hide current image container if we are replacing it
            if (currentImageContainer) {
                // We keep it visible but maybe opacity reduced or just let the new preview take focus
                // Or hide it? Let's hide it to show "this will be the new image"
                currentImageContainer.style.display = 'none';
            }

            // Close modal
            cropperModal.hide();

            // Destroy cropper
            if (cropper) {
                cropper.destroy();
                cropper = null;
            }
        }, 'image/jpeg', 0.90); // 90% quality JPG
    });

    // Clean up when modal is hidden
    document.getElementById('cropperModal').addEventListener('hidden.bs.modal', function () {
        if (cropper) {
            cropper.destroy();
            cropper = null;
        }
        // Reset file input if user cancelled and it was a new upload? 
        // No, keep it empty if cancelled creates a better UX (user has to select again)
        // Or if they edited existing, we just didn't update the input.
    });

    /**
     * Formatea un número en estilo argentino "Smart":
     * - Separador de miles: punto (.)
     * - Separador decimal: coma (,)
     * - Elimina ceros decimales innecesarios
     */
    function formatSmartAr(value) {
        if (value === null || value === undefined || value === '' || isNaN(value)) return '';

        const num = parseFloat(value);
        // Siempre mostrar 2 decimales, incluso si es 0 -> "0,00"

        // Separar parte entera y decimal
        let [integerPart, decimalPart] = num.toFixed(2).split('.');

        // Formatear parte entera con separador de miles
        integerPart = integerPart.replace(/\B(?=(\d{3})+(?!\d))/g, '.');

        // Construir resultado siempre con coma y decimales
        return `${integerPart},${decimalPart}`;
    }

    /**
     * Convierte formato argentino a número para inputs
     */
    function parseArToNumber(value) {
        if (!value) return '';
        // Eliminar puntos (separador de miles) y reemplazar coma por punto
        return value.toString().replace(/\./g, '').replace(',', '.');
    }

    /**
     * Formatea un precio en formato argentino con 2 decimales SIEMPRE:
     * - Separador de miles: punto (.)
     * - Separador decimal: coma (,)
     * - Siempre muestra 2 decimales (ej: 1.500,00)
     */
    function formatPriceAr(value) {
        if (value === null || value === undefined || value === '' || isNaN(value)) return '';

        const num = parseFloat(value);

        // Separar parte entera y decimal (siempre 2 decimales)
        let [integerPart, decimalPart] = num.toFixed(2).split('.');

        // Formatear parte entera con separador de miles
        integerPart = integerPart.replace(/\B(?=(\d{3})+(?!\d))/g, '.');

        // Construir resultado con 2 decimales siempre
        return `${integerPart},${decimalPart}`;
    }

    document.addEventListener('DOMContentLoaded', function () {
        const costInput = document.getElementById('cost');
        const salePriceInput = document.getElementById('sale_price');

        // Formatear costo al perder el foco
        // Formatear costo al perder el foco
        if (costInput) {
            costInput.addEventListener('blur', function () {
                let val = this.value;
                if (!val) {
                    this.value = '0,00';
                    return;
                }

                // Parsear: reemplazar coma por punto para obtener float
                let cleanVal = val.replace(/\./g, '').replace(',', '.');
                let numValue = parseFloat(cleanVal);

                if (!isNaN(numValue)) {
                    this.value = formatSmartAr(numValue);
                } else {
                    this.value = '0,00';
                }
            });

            costInput.addEventListener('focus', function () {
                let val = this.value;
                if (val) {
                    this.value = val.replace(/\./g, '');
                    if (this.value === '0,00' || this.value === '0') {
                        this.value = '';
                    }
                }
                this.type = 'text';
                this.select();
            });

            costInput.addEventListener('input', function () {
                this.value = this.value.replace(/[^0-9,]/g, '');
                if ((this.value.match(/,/g) || []).length > 1) {
                    this.value = this.value.replace(/,$/, '');
                }
            });
        }

        // Formatear precio de venta al perder el foco
        if (salePriceInput) {
            salePriceInput.addEventListener('blur', function () {
                let val = this.value;
                if (!val) {
                    this.value = '0,00';
                    return;
                }

                // Parsear: reemplazar coma por punto para obtener float
                let cleanVal = val.replace(/\./g, '').replace(',', '.');
                let numValue = parseFloat(cleanVal);

                if (!isNaN(numValue)) {
                    this.value = formatSmartAr(numValue);
                } else {
                    this.value = '0,00';
                }
            });

            salePriceInput.addEventListener('focus', function () {
                let val = this.value;
                if (val) {
                    this.value = val.replace(/\./g, '');
                    if (this.value === '0,00' || this.value === '0') {
                        this.value = '';
                    }
                }
                this.type = 'text';
                this.select();
            });

            salePriceInput.addEventListener('input', function () {
                this.value = this.value.replace(/[^0-9,]/g, '');
                if ((this.value.match(/,/g) || []).length > 1) {
                    this.value = this.value.replace(/,$/, '');
                }
            });
        }



        // Antes de enviar el formulario, restaurar valores numéricos
        const form = document.querySelector('form');
        if (form) {
            form.addEventListener('submit', function (e) {
                if (costInput && costInput.type === 'text') {
                    const rawValue = costInput.getAttribute('data-raw-value');
                    if (rawValue) {
                        costInput.type = 'number';
                        costInput.value = rawValue;
                    } else {
                        costInput.value = parseArToNumber(costInput.value);
                        costInput.type = 'number';
                    }
                }

                if (salePriceInput && salePriceInput.type === 'text') {
                    const rawValue = salePriceInput.getAttribute('data-raw-value');
                    if (rawValue) {
                        salePriceInput.type = 'number';
                        salePriceInput.value = rawValue;
                    } else {
                        salePriceInput.value = parseArToNumber(salePriceInput.value);
                        salePriceInput.type = 'number';
                    }
                }
            });
        }

        // Product Features Logic
        const featuresContainer = document.getElementById('featuresContainer');
        const addFeatureBtn = document.getElementById('addFeatureBtn');
        const noFeaturesMsg = document.getElementById('noFeaturesMsg');
        let featureIndex = {{ product.features| length if product and product.features else 0
    }};

    function updateNoFeaturesMsg() {
        if (featuresContainer.children.length === 0) {
            noFeaturesMsg.style.display = 'block';
        } else {
            noFeaturesMsg.style.display = 'none';
        }
    }

    addFeatureBtn.addEventListener('click', () => {
        const row = document.createElement('div');
        row.className = 'feature-row';
        row.style.display = 'grid';
        row.style.gridTemplateColumns = '1fr 1fr 40px';
        row.style.gap = 'var(--spacing-3)';
        row.style.alignItems = 'start';

        row.innerHTML = `
                <input type="text" class="form-input-custom" name="features[${featureIndex}][title]" 
                    placeholder="Nombre de la característica" required>
                <input type="text" class="form-input-custom" name="features[${featureIndex}][description]" 
                    placeholder="Descripción de la característica" required>
                <button type="button" class="btn-custom btn-ghost-custom btn-sm text-danger remove-feature-btn" title="Eliminar">
                    <i class="bi bi-trash"></i>
                </button>
            `;

        featuresContainer.appendChild(row);
        featureIndex++;
        updateNoFeaturesMsg();

        // Focus the new title input
        row.querySelector('input').focus();
    });

    featuresContainer.addEventListener('click', (e) => {
        const btn = e.target.closest('.remove-feature-btn');
        if (btn) {
            btn.closest('.feature-row').remove();
            updateNoFeaturesMsg();
        }
    });
    });
</script>
{% endblock %}