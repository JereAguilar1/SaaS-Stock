name: Weekly Backup Validation

on:
  schedule:
    # Run every Sunday at 6:00 AM UTC
    - cron: '0 6 * * 0'
  workflow_dispatch:  # Allow manual trigger

jobs:
  validate-backups:
    name: Validate Production Backups
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup SSH
        uses: webfactory/ssh-agent@v0.8.0
        with:
          ssh-private-key: ${{ secrets.VPS_SSH_KEY }}
      
      - name: Add VPS to known hosts
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan -H ${{ secrets.VPS_HOST }} >> ~/.ssh/known_hosts
      
      - name: Check backup files
        run: |
          ssh ${{ secrets.VPS_USER }}@${{ secrets.VPS_HOST }} << 'EOF'
            echo "=== Backup Validation Report ==="
            
            BACKUP_DIR="/var/backups/ferreteria/daily"
            
            # Check if backup directory exists
            if [ ! -d "$BACKUP_DIR" ]; then
              echo "ERROR: Backup directory does not exist: $BACKUP_DIR"
              exit 1
            fi
            
            # Count backups
            BACKUP_COUNT=$(ls -1 $BACKUP_DIR/*.sql.gz 2>/dev/null | wc -l)
            echo "Total backups found: $BACKUP_COUNT"
            
            if [ $BACKUP_COUNT -eq 0 ]; then
              echo "ERROR: No backup files found!"
              exit 1
            fi
            
            # Check most recent backup
            LATEST_BACKUP=$(ls -t $BACKUP_DIR/*.sql.gz | head -1)
            BACKUP_SIZE=$(du -h "$LATEST_BACKUP" | cut -f1)
            BACKUP_AGE=$(find "$LATEST_BACKUP" -mtime -2 | wc -l)
            
            echo "Latest backup: $(basename $LATEST_BACKUP)"
            echo "Size: $BACKUP_SIZE"
            
            if [ $BACKUP_AGE -eq 0 ]; then
              echo "WARNING: Latest backup is older than 2 days!"
            fi
            
            # Verify backup integrity
            echo "Verifying backup integrity..."
            if gunzip -t "$LATEST_BACKUP" 2>/dev/null; then
              echo "✓ Backup file integrity: OK"
            else
              echo "✗ Backup file integrity: FAILED"
              exit 1
            fi
            
            # List recent backups
            echo ""
            echo "Recent backups (last 7):"
            ls -lht $BACKUP_DIR/*.sql.gz | head -7
            
            # Check disk space
            echo ""
            echo "Disk space:"
            df -h /var/backups
            
            echo ""
            echo "=== Validation completed successfully ==="
          EOF
      
      - name: Test restore capability (dry run)
        run: |
          ssh ${{ secrets.VPS_USER }}@${{ secrets.VPS_HOST }} << 'EOF'
            echo "Testing restore capability..."
            
            LATEST_BACKUP=$(ls -t /var/backups/ferreteria/daily/*.sql.gz | head -1)
            
            # Test that backup can be decompressed
            gunzip -c "$LATEST_BACKUP" | head -20 > /dev/null
            
            if [ $? -eq 0 ]; then
              echo "✓ Backup can be decompressed successfully"
            else
              echo "✗ ERROR: Failed to decompress backup"
              exit 1
            fi
            
            # Verify SQL syntax (first 100 lines)
            if gunzip -c "$LATEST_BACKUP" | head -100 | grep -q "CREATE TABLE"; then
              echo "✓ Backup contains valid SQL statements"
            else
              echo "✗ WARNING: Backup may not contain valid SQL"
            fi
          EOF
      
      - name: Send notification
        if: always()
        run: |
          if [ "${{ job.status }}" = "success" ]; then
            echo "✓ Backup validation passed"
            # Add Slack/Email notification here
          else
            echo "✗ Backup validation failed!"
            # Add Slack/Email alert here
          fi
